<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="904px" preserveAspectRatio="none" style="width:1226px;height:904px;" version="1.1" viewBox="0 0 1226 904" width="1226px" zoomAndPan="magnify"><defs><filter height="300%" id="fa9jtb5izft64" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="147" x="538.5" y="30.8799">udp_lib_get_port</text><ellipse cx="697.125" cy="46.0638" fill="#000000" filter="url(#fa9jtb5izft64)" rx="10" ry="10" style="stroke: none; stroke-width: 1.0;"/><polygon fill="#FEFECE" filter="url(#fa9jtb5izft64)" points="669.625,76.0638,724.625,76.0638,736.625,88.0638,724.625,100.0638,669.625,100.0638,657.625,88.0638,669.625,76.0638" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="55" x="669.625" y="92.8598">指定端口？</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="33" x="624.625" y="84.8959">未指定</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="44" x="736.625" y="84.8959">指定端口</text><path d="M78,114.3399 L78,143.1639 A0,0 0 0 0 78,143.1639 L278,143.1639 A0,0 0 0 0 278,143.1639 L278,132.7519 L298,128.7519 L278,124.7519 L278,124.3399 L268,114.3399 L78,114.3399 A0,0 0 0 0 78,114.3399 " fill="#FBFB77" filter="url(#fa9jtb5izft64)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M268,114.3399 L268,124.3399 L278,124.3399 L268,114.3399 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179" x="84" y="134.4199">分配位图，记录slot上的端口号</text><rect fill="#FEFECE" filter="url(#fa9jtb5izft64)" height="37.3761" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="179" x="298" y="110.0638"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="156" x="311" y="133.9839">DECLARE_BITMAP(bitmap...</text><rect fill="#FEFECE" filter="url(#fa9jtb5izft64)" height="54.7522" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="203" x="286" y="167.44"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="172" x="299" y="191.3601">inet_sk_get_local_port_range</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="180" x="299" y="208.7362">获取端口范围，从该范围分配端口</text><rect fill="#FEFECE" filter="url(#fa9jtb5izft64)" height="37.3761" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="107" x="334" y="257.1922"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="84" x="347" y="281.1123">对端口取随机值</text><rect fill="#FEFECE" filter="url(#fa9jtb5izft64)" height="54.7522" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="170" x="302.5" y="394.1922"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="76" x="315.5" y="418.1123">udp_hashslot</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="147" x="315.5" y="435.4884">根据端口定位hash槽位链表</text><path d="M20,483.9444 L20,644.5366 A0,0 0 0 0 20,644.5366 L272,644.5366 A0,0 0 0 0 272,644.5366 L272,568.2405 L292,564.2405 L272,560.2405 L272,493.9444 L262,483.9444 L20,483.9444 A0,0 0 0 0 20,483.9444 " fill="#FBFB77" filter="url(#fa9jtb5izft64)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M262,483.9444 L262,493.9444 L272,493.9444 L262,483.9444 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="26" y="504.0245">比较内容：</text><ellipse cx="31.5" cy="519.0925" fill="#000000" rx="2.5" ry="2.5" style="stroke: #000000; stroke-width: 0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="37" y="522.8485">网络命名空间相同</text><ellipse cx="31.5" cy="537.9165" fill="#000000" rx="2.5" ry="2.5" style="stroke: #000000; stroke-width: 0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="67" x="37" y="541.6725">非同一sock</text><ellipse cx="31.5" cy="556.7405" fill="#000000" rx="2.5" ry="2.5" style="stroke: #000000; stroke-width: 0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="203" x="37" y="560.4965">使用bitmap或者端口号相同 ？？？</text><ellipse cx="31.5" cy="575.5645" fill="#000000" rx="2.5" ry="2.5" style="stroke: #000000; stroke-width: 0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="220" x="37" y="579.3205">本次sock或者链表sock中sk_reuse为0</text><ellipse cx="31.5" cy="594.3885" fill="#000000" rx="2.5" ry="2.5" style="stroke: #000000; stroke-width: 0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="37" y="598.1445">sock为绑定if，或者绑定if不同</text><ellipse cx="31.5" cy="613.2126" fill="#000000" rx="2.5" ry="2.5" style="stroke: #000000; stroke-width: 0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="37" y="616.9686">绑定地址相同</text><ellipse cx="31.5" cy="632.0366" fill="#000000" rx="2.5" ry="2.5" style="stroke: #000000; stroke-width: 0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="37" y="635.7926">都开启reuseport</text><rect fill="#FEFECE" filter="url(#fa9jtb5izft64)" height="54.7522" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="191" x="292" y="536.8644"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="112" x="305" y="560.7845">udp_lib_lport_inuse</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="168" x="305" y="578.1606">遍历该链表端口，检查是否可用</text><polygon fill="#FEFECE" filter="url(#fa9jtb5izft64)" points="365.5,664.5366,409.5,664.5366,421.5,676.5366,409.5,688.5366,365.5,688.5366,353.5,676.5366,365.5,664.5366" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="17" x="391.5" y="701.2965">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="44" x="365.5" y="681.3325">端口可用</text><polygon fill="#FEFECE" filter="url(#fa9jtb5izft64)" points="387.5,329.5683,399.5,341.5683,387.5,353.5683,375.5,341.5683,387.5,329.5683" style="stroke: #A80036; stroke-width: 1.5;"/><polygon fill="#FEFECE" filter="url(#fa9jtb5izft64)" points="320,753.5005,455,753.5005,467,765.5005,455,777.5005,320,777.5005,308,765.5005,320,753.5005" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="135" x="320" y="770.2965">端口遍历完成) then (未完成</text><polygon fill="#FEFECE" filter="url(#fa9jtb5izft64)" points="387.5,797.5005,399.5,809.5005,387.5,821.5005,375.5,809.5005,387.5,797.5005" style="stroke: #A80036; stroke-width: 1.5;"/><rect fill="#FEFECE" filter="url(#fa9jtb5izft64)" height="37.3761" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="99" x="985.25" y="110.0638"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="76" x="998.25" y="133.9839">udp_hashslot</text><polygon fill="#FEFECE" filter="url(#fa9jtb5izft64)" points="990.25,167.44,1079.25,167.44,1091.25,179.44,1079.25,191.44,990.25,191.44,978.25,179.44,990.25,167.44" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="89" x="990.25" y="184.2359">链表节点数超过10</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="17" x="961.25" y="176.272">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="78" x="1091.25" y="176.272">链表节点小于10</text><path d="M509,223.0921 L509,251.9161 A0,0 0 0 0 509,251.9161 L764,251.9161 A0,0 0 0 0 764,251.9161 L764,241.5041 L784,237.5041 L764,233.5041 L764,233.0921 L754,223.0921 L509,223.0921 A0,0 0 0 0 509,223.0921 " fill="#FBFB77" filter="url(#fa9jtb5izft64)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M754,223.0921 L754,233.0921 L764,233.0921 L754,223.0921 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="515" y="243.1721">优化措施：避免节点太多，增加遍历次数</text><rect fill="#FEFECE" filter="url(#fa9jtb5izft64)" height="72.1284" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="276" x="784" y="201.44"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="151" x="797" y="225.3601">尝试使用udp_table2 查找：</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="253" x="797" y="242.7362">如果udp_table2对应链表节点大于udp_table，</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="117" x="797" y="260.1123">则还是使用udp_table</text><rect fill="#FEFECE" filter="url(#fa9jtb5izft64)" height="37.3761" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="106" x="869" y="308.5683"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="83" x="882" y="332.4884">udp_hashslot2</text><rect fill="#FEFECE" filter="url(#fa9jtb5izft64)" height="37.3761" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="142" x="851" y="373.5683"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="119" x="864" y="397.4884">udp_lib_lport_inuse2</text><rect fill="#FEFECE" filter="url(#fa9jtb5izft64)" height="37.3761" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="260" x="792" y="445.9444"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="237" x="805" y="469.8645">如果不存在，则使用 null地址+端口 再次查找</text><rect fill="#FEFECE" filter="url(#fa9jtb5izft64)" height="37.3761" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="135" x="1080" y="201.44"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="112" x="1093" y="225.3601">udp_lib_lport_inuse</text><polygon fill="#FEFECE" filter="url(#fa9jtb5izft64)" points="1034.75,489.3206,1046.75,501.3206,1034.75,513.3206,1022.75,501.3206,1034.75,489.3206" style="stroke: #A80036; stroke-width: 1.5;"/><polygon fill="#FEFECE" filter="url(#fa9jtb5izft64)" points="697.125,827.5005,709.125,839.5005,697.125,851.5005,685.125,839.5005,697.125,827.5005" style="stroke: #A80036; stroke-width: 1.5;"/><ellipse cx="697.125" cy="882.5005" fill="#FFFFFF" filter="url(#fa9jtb5izft64)" rx="11" ry="11" style="stroke: #000000; stroke-width: 1.0;"/><ellipse cx="697.125" cy="882.5005" fill="#000000" rx="6" ry="6" style="stroke: #7F7F7F; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="387.5" x2="387.5" y1="147.44" y2="167.44"/><polygon fill="#A80036" points="383.5,157.44,387.5,167.44,391.5,157.44,387.5,161.44" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="387.5" x2="387.5" y1="222.1922" y2="257.1922"/><polygon fill="#A80036" points="383.5,247.1922,387.5,257.1922,391.5,247.1922,387.5,251.1922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="387.5" x2="387.5" y1="448.9444" y2="536.8644"/><polygon fill="#A80036" points="383.5,526.8644,387.5,536.8644,391.5,526.8644,387.5,530.8644" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="387.5" x2="387.5" y1="688.5366" y2="714.5005"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="387.5" x2="10" y1="714.5005" y2="714.5005"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="10" x2="10" y1="714.5005" y2="809.5005"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="10" x2="375.5" y1="809.5005" y2="809.5005"/><polygon fill="#A80036" points="365.5,805.5005,375.5,809.5005,365.5,813.5005,369.5,809.5005" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="421.5" x2="433.5" y1="676.5366" y2="676.5366"/><polygon fill="#A80036" points="429.5,701.5005,433.5,711.5005,437.5,701.5005,433.5,705.5005" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="433.5" x2="433.5" y1="676.5366" y2="733.5005"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="433.5" x2="387.5" y1="733.5005" y2="733.5005"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="387.5" x2="387.5" y1="733.5005" y2="753.5005"/><polygon fill="#A80036" points="383.5,743.5005,387.5,753.5005,391.5,743.5005,387.5,747.5005" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="387.5" x2="387.5" y1="591.6166" y2="664.5366"/><polygon fill="#A80036" points="383.5,654.5366,387.5,664.5366,391.5,654.5366,387.5,658.5366" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="387.5" x2="387.5" y1="353.5683" y2="394.1922"/><polygon fill="#A80036" points="383.5,384.1922,387.5,394.1922,391.5,384.1922,387.5,388.1922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="467" x2="495" y1="765.5005" y2="765.5005"/><polygon fill="#A80036" points="491,587.8283,495,577.8283,499,587.8283,495,583.8283" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="495" x2="495" y1="341.5683" y2="765.5005"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="495" x2="399.5" y1="341.5683" y2="341.5683"/><polygon fill="#A80036" points="409.5,337.5683,399.5,341.5683,409.5,345.5683,405.5,341.5683" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="387.5" x2="387.5" y1="777.5005" y2="797.5005"/><polygon fill="#A80036" points="383.5,787.5005,387.5,797.5005,391.5,787.5005,387.5,791.5005" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="387.5" x2="387.5" y1="294.5683" y2="329.5683"/><polygon fill="#A80036" points="383.5,319.5683,387.5,329.5683,391.5,319.5683,387.5,323.5683" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="922" x2="922" y1="273.5683" y2="308.5683"/><polygon fill="#A80036" points="918,298.5683,922,308.5683,926,298.5683,922,302.5683" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="922" x2="922" y1="345.9444" y2="373.5683"/><polygon fill="#A80036" points="918,363.5683,922,373.5683,926,363.5683,922,367.5683" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="922" x2="922" y1="410.9444" y2="445.9444"/><polygon fill="#A80036" points="918,435.9444,922,445.9444,926,435.9444,922,439.9444" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="978.25" x2="922" y1="179.44" y2="179.44"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="922" x2="922" y1="179.44" y2="201.44"/><polygon fill="#A80036" points="918,191.44,922,201.44,926,191.44,922,195.44" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1091.25" x2="1147.5" y1="179.44" y2="179.44"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1147.5" x2="1147.5" y1="179.44" y2="201.44"/><polygon fill="#A80036" points="1143.5,191.44,1147.5,201.44,1151.5,191.44,1147.5,195.44" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="922" x2="922" y1="483.3206" y2="501.3206"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="922" x2="1022.75" y1="501.3206" y2="501.3206"/><polygon fill="#A80036" points="1012.75,497.3206,1022.75,501.3206,1012.75,505.3206,1016.75,501.3206" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1147.5" x2="1147.5" y1="238.8161" y2="501.3206"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1147.5" x2="1046.75" y1="501.3206" y2="501.3206"/><polygon fill="#A80036" points="1056.75,497.3206,1046.75,501.3206,1056.75,505.3206,1052.75,501.3206" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1034.75" x2="1034.75" y1="147.44" y2="167.44"/><polygon fill="#A80036" points="1030.75,157.44,1034.75,167.44,1038.75,157.44,1034.75,161.44" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="657.625" x2="387.5" y1="88.0638" y2="88.0638"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="387.5" x2="387.5" y1="88.0638" y2="110.0638"/><polygon fill="#A80036" points="383.5,100.0638,387.5,110.0638,391.5,100.0638,387.5,104.0638" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="736.625" x2="1034.75" y1="88.0638" y2="88.0638"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1034.75" x2="1034.75" y1="88.0638" y2="110.0638"/><polygon fill="#A80036" points="1030.75,100.0638,1034.75,110.0638,1038.75,100.0638,1034.75,104.0638" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="387.5" x2="387.5" y1="821.5005" y2="839.5005"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="387.5" x2="685.125" y1="839.5005" y2="839.5005"/><polygon fill="#A80036" points="675.125,835.5005,685.125,839.5005,675.125,843.5005,679.125,839.5005" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1034.75" x2="1034.75" y1="513.3206" y2="839.5005"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1034.75" x2="709.125" y1="839.5005" y2="839.5005"/><polygon fill="#A80036" points="719.125,835.5005,709.125,839.5005,719.125,843.5005,715.125,839.5005" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="697.125" x2="697.125" y1="56.0638" y2="76.0638"/><polygon fill="#A80036" points="693.125,66.0638,697.125,76.0638,701.125,66.0638,697.125,70.0638" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="697.125" x2="697.125" y1="851.5005" y2="871.5005"/><polygon fill="#A80036" points="693.125,861.5005,697.125,871.5005,701.125,861.5005,697.125,865.5005" style="stroke: #A80036; stroke-width: 1.0;"/><!--MD5=[ca68e86ff92205b72a80c48db4550c9e]
@startuml
title udp_lib_get_port
start
if (指定端口？) then (未指定)
  : DECLARE_BITMAP(bitmap...;
  note left
    分配位图，记录slot上的端口号
  end note

  : inet_sk_get_local_port_range
   获取端口范围，从该范围分配端口;
  : 对端口取随机值;
  repeat
    : udp_hashslot
     根据端口定位hash槽位链表;
    : udp_lib_lport_inuse
     遍历该链表端口，检查是否可用;
    note left
    比较内容：
    * 网络命名空间相同
    * 非同一sock
    * 使用bitmap或者端口号相同 ？？？
    * 本次sock或者链表sock中sk_reuse为0
    * sock为绑定if，或者绑定if不同
    * 绑定地址相同
    * 都开启reuseport
    end note
    if (端口可用) then (yes)
      break;
    endif
  repeat while (端口遍历完成) then (未完成)
else (指定端口)
  : udp_hashslot;
  if (链表节点数超过10) then (yes)
    : 尝试使用udp_table2 查找：
     如果udp_table2对应链表节点大于udp_table，
     则还是使用udp_table;
    note left
      优化措施：避免节点太多，增加遍历次数
    end note

    : udp_hashslot2;
    : udp_lib_lport_inuse2;
    : 如果不存在，则使用 null地址+端口 再次查找;
  else (链表节点小于10)
    : udp_lib_lport_inuse;
  endif
endif


stop
@enduml

PlantUML version 1.2020.02(Sun Mar 01 18:22:07 CST 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 17.0.11+9-Debian-1deb12u1
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>