<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh" xml:lang="zh">
<head>
<!-- 2024-06-23 Sun 15:55 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>流量控制</title>
<meta name="author" content="nandfan" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="../styles/myself/css/worg.css"/>
</head>
<body>
<div id="content" class="content">
<h1 class="title">流量控制</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org1167111">1. 流量控制的输出</a>
<ul>
<li><a href="#orgc3cc5e4">1.1. dev_queue_xmit()</a></li>
<li><a href="#org16bb616">1.2. qdisc_restart()</a></li>
</ul>
</li>
<li><a href="#org887b9a7">2. 流量控制的三种元素</a>
<ul>
<li><a href="#orgdede431">2.1. 排队规则</a>
<ul>
<li><a href="#orgfecb97b">2.1.1. Qdisc结构</a></li>
<li><a href="#org84a4b4f">2.1.2. Qdisc_ops结构</a></li>
<li><a href="#orgcf9b22f">2.1.3. 排队规则相关函数</a></li>
</ul>
</li>
<li><a href="#org82c43bc">2.2. 类</a>
<ul>
<li><a href="#orgfcaeeff">2.2.1. xxx_class结构</a></li>
<li><a href="#orgf266f79">2.2.2. Qdisc_class_ops结构</a></li>
<li><a href="#orga391bbc">2.2.3. 类的相关函数</a></li>
</ul>
</li>
<li><a href="#org9d2dc82">2.3. 过滤器</a>
<ul>
<li><a href="#org030b6af">2.3.1. tcf_proto结构</a></li>
<li><a href="#org6fc02ed">2.3.2. tcf_proto_ops结构</a></li>
<li><a href="#orgc2c8c86">2.3.3. 过滤器相关函数</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgd8dd161">3. 默认的FIFO排队规则</a>
<ul>
<li><a href="#org823283b">3.1. pfifo_fast_init</a></li>
<li><a href="#orgc0fac01">3.2. pfifo_fast_reset()</a></li>
<li><a href="#org2c52c48">3.3. pfifo_fast_enqueue()</a></li>
<li><a href="#orgc6668b4">3.4. pfifo_fast_dequeue()</a></li>
<li><a href="#orgc7a4704">3.5. pfifo_fast_requeue()</a></li>
</ul>
</li>
<li><a href="#orgf7d3e52">4. netlink的tc接口</a></li>
<li><a href="#org3ca10bd">5. 排队规则的创建接口</a>
<ul>
<li><a href="#org0a61b43">5.1. 类的创建接口</a></li>
<li><a href="#orgfa83de9">5.2. 过滤器的创建接口</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org1167111" class="outline-2">
<h2 id="org1167111"><span class="section-number-2">1.</span> 流量控制的输出</h2>
<div class="outline-text-2" id="text-1">

<div id="org1d4db04" class="figure">
<p><img src="image/qos/qos-output.png" alt="qos-output.png" />
</p>
<p><span class="figure-number">Figure 1: </span>流量控制在接口层输出的位置</p>
</div>

<p>
链路层中数据包通过dev_queue_xmit()输出， 其中如果需要通过QOS发送，则排入QOS队列，之后激活数据包输出软中断，之后在软中断中，从QOS队列获取优先级最高的数据包，调用dev_hard_start_xmit()输出到网络设备。否则直接调用网卡驱动注册的发送函数发送。
</p>
</div>

<div id="outline-container-orgc3cc5e4" class="outline-3">
<h3 id="orgc3cc5e4"><span class="section-number-3">1.1.</span> dev_queue_xmit()</h3>
<div class="outline-text-3" id="text-1-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #66D9EF;">int</span> <span style="color: #A6E22E;">dev_queue_xmit</span>(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">sk_buff</span> *<span style="color: #FD971F;">skb</span>)
{
        <span style="color: #75715E;">//</span><span style="color: #75715E;">......</span>
        q = rcu_dereference(dev-&gt;qdisc);
<span style="color: #F92672;">#ifdef</span> CONFIG_NET_CLS_ACT
        skb-&gt;tc_verd = SET_TC_AT(skb-&gt;tc_verd,AT_EGRESS);
<span style="color: #F92672;">#endif</span>
        <span style="color: #F92672;">if</span> (q-&gt;enqueue) {<span style="color: #75715E;">//</span><span style="color: #75715E;">&#38431;&#21015;&#26159;&#21542;&#23450;&#20041;&#20102;&#20837;&#38431;&#20989;&#25968;</span>
                spin_lock(&amp;dev-&gt;queue_lock);
                q = dev-&gt;qdisc;
                <span style="color: #F92672;">if</span> (q-&gt;enqueue) {
                        rc = q-&gt;enqueue(skb, q);
                        qdisc_run(dev);<span style="color: #75715E;">//</span><span style="color: #75715E;">&#36890;&#36807;qdisc_run()&#35843;&#24230;&#25968;&#25454;&#21253;&#36755;&#20986;&#36719;&#20013;&#26029;</span>
                        spin_unlock(&amp;dev-&gt;queue_lock);
                        rc = rc == NET_XMIT_BYPASS ? NET_XMIT_SUCCESS : rc;
                        <span style="color: #F92672;">goto</span> <span style="color: #AE81FF;">out</span>;
                }
                spin_unlock(&amp;dev-&gt;queue_lock);
        }
        <span style="color: #75715E;">//</span><span style="color: #75715E;">......</span>
}
</pre>
</div>

<p>
dev_queue_xmit中，通过qdisc_run()调度数据包输出软中断。
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #F92672;">static</span> <span style="color: #F92672;">inline</span> <span style="color: #66D9EF;">void</span> <span style="color: #A6E22E;">qdisc_run</span>(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">net_device</span> *<span style="color: #FD971F;">dev</span>)
{
        <span style="color: #F92672;">if</span> (<span style="color: #E6DB74; font-weight: bold;">!</span>netif_queue_stopped(dev) &amp;&amp;<span style="color: #75715E;">//</span><span style="color: #75715E;">&#35774;&#22791;&#26159;&#21542;&#22788;&#20110;&#21551;&#29992;&#29366;&#24577;</span>
            <span style="color: #E6DB74; font-weight: bold;">!</span>test_and_set_bit(__LINK_STATE_QDISC_RUNNING, &amp;dev-&gt;state)) <span style="color: #75715E;">//</span><span style="color: #75715E;">&#27809;&#26377;&#22788;&#20110;&#27969;&#37327;&#25511;&#21046;&#35843;&#24230;&#38431;&#21015;&#36807;&#31243;</span>
                __qdisc_run(dev);
}

<span style="color: #66D9EF;">void</span> <span style="color: #A6E22E;">__qdisc_run</span>(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">net_device</span> *<span style="color: #FD971F;">dev</span>)
{
        <span style="color: #F92672;">if</span> (unlikely(dev-&gt;qdisc == &amp;noop_qdisc))<span style="color: #75715E;">//</span><span style="color: #75715E;">&#25490;&#38431;&#35268;&#21017;&#22788;&#20110;&#21021;&#22987;&#29366;&#24577;&#65292;&#30452;&#25509;&#36864;&#20986;</span>
                <span style="color: #F92672;">goto</span> <span style="color: #AE81FF;">out</span>;
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#35843;&#29992;qdisc_restart()&#21457;&#36865;&#65292;&#30452;&#21040;&#21457;&#36865;&#23436;&#27605;&#65292;&#25110;&#32773;&#35774;&#22791;&#20026;&#20572;&#27490;&#29366;&#24577;&#12290;</span>
        <span style="color: #F92672;">while</span> (qdisc_restart(dev) &lt; 0 &amp;&amp; <span style="color: #E6DB74; font-weight: bold;">!</span>netif_queue_stopped(dev))
                <span style="color: #75715E;">/* </span><span style="color: #75715E;">NOTHING</span><span style="color: #75715E;"> */</span>;
<span style="color: #AE81FF;">out</span>:
        clear_bit(__LINK_STATE_QDISC_RUNNING, &amp;dev-&gt;state);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org16bb616" class="outline-3">
<h3 id="org16bb616"><span class="section-number-3">1.2.</span> qdisc_restart()</h3>
<div class="outline-text-3" id="text-1-2">
<p>
qdisc_restart()的主要作用是从排队规则中获取一个可以输出的报文，然后将其输出到网络设备。
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #75715E;">/*</span>
<span style="color: #75715E;">   Returns:  0  - &#38431;&#21015;&#20026;&#31354;</span>
<span style="color: #75715E;">            &gt;0  - &#38431;&#21015;&#19981;&#20026;&#31354;&#65292;&#20294;&#26159;&#21457;&#36865;&#22833;&#36133;&#65292;&#38656;&#35201;&#31561;&#24453;&#19979;&#27425;&#21457;&#36865;</span>
<span style="color: #75715E;">            &lt;0  - &#38431;&#21015;&#19981;&#20026;&#31354;&#12290; &#20294;&#26159;&#30001;&#20110;&#19978;&#38145;&#22833;&#36133; &#25110;&#32773; &#21457;&#36865;&#25104;&#21151;&#21518;&#65292;&#38656;&#35201;&#31561;&#24453;&#19979;&#27425;&#21457;&#36865;</span>
<span style="color: #75715E;">*/</span>
<span style="color: #F92672;">static</span> <span style="color: #F92672;">inline</span> <span style="color: #66D9EF;">int</span> <span style="color: #A6E22E;">qdisc_restart</span>(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">net_device</span> *<span style="color: #FD971F;">dev</span>)
{
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *<span style="color: #FD971F;">q</span> = dev-&gt;qdisc;
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">sk_buff</span> *<span style="color: #FD971F;">skb</span>;
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#22914;&#26524;&#36824;&#26377;&#19978;&#27425;&#27809;&#26377;&#21457;&#36865;&#23436;&#30340;GSO&#25968;&#25454;&#21253;&#65292;&#21017;&#20808;&#21457;&#36865;GSO&#65292;&#21542;&#21017;&#20174;&#25490;&#38431;&#35268;&#21017;&#38431;&#21015;&#20986;&#38431;SKB</span>
        <span style="color: #F92672;">if</span> (((skb = dev-&gt;gso_skb)) || ((skb = q-&gt;dequeue(q)))) {
                <span style="color: #66D9EF;">unsigned</span> <span style="color: #FD971F;">nolock</span> = (dev-&gt;features &amp; NETIF_F_LLTX);
                dev-&gt;gso_skb = <span style="color: #AE81FF;">NULL</span>;<span style="color: #75715E;">//</span><span style="color: #75715E;">&#20808;&#23558;gso_skb&#28165;&#38646;&#65292;&#22914;&#26524;&#26412;&#27425;&#36824;&#26377;gso&#25968;&#25454;&#21253;&#27809;&#21457;&#23436;&#65292;&#21017;&#37325;&#26032;&#35774;&#32622;</span>
                <span style="color: #F92672;">if</span> (<span style="color: #E6DB74; font-weight: bold;">!</span>nolock) {<span style="color: #75715E;">//</span><span style="color: #75715E;">&#36755;&#20986;&#38656;&#35201;&#19978;&#38145;</span>
                        <span style="color: #F92672;">if</span> (<span style="color: #E6DB74; font-weight: bold;">!</span>netif_tx_trylock(dev)) {<span style="color: #75715E;">//</span><span style="color: #75715E;">&#19978;&#38145;&#22833;&#36133;</span>
                        <span style="color: #AE81FF;">collision</span>:
                                <span style="color: #75715E;">//</span><span style="color: #75715E;">&#22914;&#26524;&#26159;&#24403;&#21069;CPU&#33719;&#21462;&#20102;&#38145;&#65292;&#21017;&#21028;&#23450;&#20986;&#29616;&#27515;&#38145;</span>
                                <span style="color: #F92672;">if</span> (dev-&gt;xmit_lock_owner == smp_processor_id()) {
                                        kfree_skb(skb);
                                        <span style="color: #F92672;">if</span> (net_ratelimit())
                                                printk(KERN_DEBUG <span style="color: #E6DB74;">"Dead loop on netdevice %s, fix it urgently!\n"</span>, dev-&gt;name);
                                        <span style="color: #F92672;">return</span> -1;
                                }
                                __get_cpu_var(netdev_rx_stat).cpu_collision++;<span style="color: #75715E;">//</span><span style="color: #75715E;">&#26356;&#26032;&#32479;&#35745;</span>
                                <span style="color: #F92672;">goto</span> <span style="color: #AE81FF;">requeue</span>;<span style="color: #75715E;">//</span><span style="color: #75715E;">&#37325;&#26032;&#20837;&#38431;</span>
                        }
                }
                {
                        <span style="color: #75715E;">/* </span><span style="color: #75715E;">And release queue</span><span style="color: #75715E;"> */</span>
                        spin_unlock(&amp;dev-&gt;queue_lock);
                        <span style="color: #F92672;">if</span> (<span style="color: #E6DB74; font-weight: bold;">!</span>netif_queue_stopped(dev)) { <span style="color: #75715E;">//</span><span style="color: #75715E;">&#20877;&#27425;&#26816;&#27979;&#32593;&#32476;&#35774;&#22791;&#26159;&#21542;&#20851;&#38381;&#25490;&#38431;&#21151;&#33021;</span>
                                <span style="color: #66D9EF;">int</span> <span style="color: #FD971F;">ret</span>;
                                ret = dev_hard_start_xmit(skb, dev); <span style="color: #75715E;">//</span><span style="color: #75715E;">&#36890;&#36807;&#35774;&#22791;&#36755;&#20986;&#25968;&#25454;&#21253;</span>
                                <span style="color: #F92672;">if</span> (ret == NETDEV_TX_OK) {
                                        <span style="color: #F92672;">if</span> (<span style="color: #E6DB74; font-weight: bold;">!</span>nolock) {<span style="color: #75715E;">//</span><span style="color: #75715E;">&#21457;&#36865;&#25104;&#21151;&#65292;&#37322;&#25918;&#38145;</span>
                                                netif_tx_unlock(dev);
                                        }
                                        spin_lock(&amp;dev-&gt;queue_lock);
                                        <span style="color: #F92672;">return</span> -1;
                                }
                                <span style="color: #F92672;">if</span> (ret == NETDEV_TX_LOCKED &amp;&amp; nolock) {<span style="color: #75715E;">//</span><span style="color: #75715E;">&#33719;&#21462;&#38145;&#22833;&#36133;&#23548;&#33268;&#30340;&#21457;&#36865;&#22833;&#36133;</span>
                                        spin_lock(&amp;dev-&gt;queue_lock);
                                        <span style="color: #F92672;">goto</span> <span style="color: #AE81FF;">collision</span>;
                                }
                        }
                        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#35774;&#22791;&#20851;&#38381;&#25490;&#38431;&#21151;&#33021;&#30340;&#24773;&#20917;&#65306;</span>
                        <span style="color: #F92672;">if</span> (<span style="color: #E6DB74; font-weight: bold;">!</span>nolock) {
                                netif_tx_unlock(dev);
                        }
                        spin_lock(&amp;dev-&gt;queue_lock);
                        q = dev-&gt;qdisc;
                }
<span style="color: #AE81FF;">requeue</span>: <span style="color: #75715E;">//</span><span style="color: #75715E;">&#37325;&#26032;&#23558;&#25968;&#25454;&#21253;&#20837;&#38431;</span>
                <span style="color: #F92672;">if</span> (skb-&gt;next)
                        dev-&gt;gso_skb = skb;
                <span style="color: #F92672;">else</span>
                        q-&gt;ops-&gt;requeue(skb, q);
                netif_schedule(dev);
                <span style="color: #F92672;">return</span> 1;
        }
        BUG_ON((<span style="color: #66D9EF;">int</span>) q-&gt;q.qlen &lt; 0);
        <span style="color: #F92672;">return</span> q-&gt;q.qlen;
}
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-org887b9a7" class="outline-2">
<h2 id="org887b9a7"><span class="section-number-2">2.</span> 流量控制的三种元素</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>排队规则</li>
<li>类</li>
<li>过滤器</li>
</ul>


<p>
启用流量控制的情况下，每个网络设备至少会配置一个排队规则。待发送报文输出到链路层时，被按规则排入到队列。
</p>

<p>
类定义在排队规则中，通过排队规则的类来区分报文。排队规则中可以把保温分配到不同的类。排队规则可以没有类，也可以有多个类。
</p>

<p>
过滤器用来将输出报文分配到 <b>排队规则的分类</b> 中。一个过滤器包含若干个匹配条件，如果符合条件，则按对应的过滤器分类。
</p>


<div id="orgf5ca8e2" class="figure">
<p><img src="dot/qos/qos-tree.png" alt="qos-tree.png" />
</p>
</div>


<div id="orgd440c73" class="figure">
<p><img src="image/qos/qos-itf.png" alt="qos-itf.png" />
</p>
<p><span class="figure-number">Figure 2: </span>流量控制与接口层输出之间的关联</p>
</div>

<ul class="org-ul">
<li>dev_queue_xmit()输出时，如果支持流量控制，则调用根排队规则的enqueue函数进行入队。</li>
<li>qdisc_restart() 中出队时，则调用根排队规则的dequeue函数。</li>
</ul>
</div>

<div id="outline-container-orgdede431" class="outline-3">
<h3 id="orgdede431"><span class="section-number-3">2.1.</span> 排队规则</h3>
<div class="outline-text-3" id="text-2-1">
<p>
排队规则包括无类和有类两种：
</p>
<ul class="org-ul">
<li>无类的排队规则内部不包含可配置子类队列。</li>
<li>有类的排队规则可以包含根多的类，每个类有可以包含一个排队规则。</li>
</ul>
</div>

<div id="outline-container-orgfecb97b" class="outline-4">
<h4 id="orgfecb97b"><span class="section-number-4">2.1.1.</span> Qdisc结构</h4>
<div class="outline-text-4" id="text-2-1-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span>
{
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#38431;&#21015;&#25552;&#20379;&#30340;&#20837;&#38431;&#25805;&#20316;&#25509;&#21475;</span>
        <span style="color: #66D9EF;">int</span>               (*<span style="color: #A6E22E;">enqueue</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">sk_buff</span> *<span style="color: #FD971F;">skb</span>, <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *<span style="color: #FD971F;">dev</span>);
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">sk_buff</span> *        (*<span style="color: #A6E22E;">dequeue</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *<span style="color: #FD971F;">dev</span>);<span style="color: #75715E;">//</span><span style="color: #75715E;">&#20986;&#38431;&#25805;&#20316;&#25509;&#21475;</span>
        <span style="color: #66D9EF;">unsigned</span>                <span style="color: #FD971F;">flags</span>;
<span style="color: #F92672;">#define</span> <span style="color: #FD971F;">TCQ_F_BUILTIN</span>   1  <span style="color: #75715E;">//</span><span style="color: #75715E;">&#26631;&#35782;&#25490;&#38431;&#35268;&#21017;&#26159;&#31354;&#25490;&#38431;&#35268;&#21017;</span>
<span style="color: #F92672;">#define</span> <span style="color: #FD971F;">TCQ_F_THROTTLED</span> 2  <span style="color: #75715E;">//</span><span style="color: #75715E;">&#26631;&#35782;&#25490;&#38431;&#35268;&#21017;&#30001;&#20110;&#38480;&#21046;&#32780;&#22788;&#20110;&#24310;&#26102;&#20986;&#38431;&#30340;&#29366;&#24577;&#20013;</span>
<span style="color: #F92672;">#define</span> <span style="color: #FD971F;">TCQ_F_INGRESS</span>   4  <span style="color: #75715E;">//</span><span style="color: #75715E;">&#25490;&#38431;&#35268;&#21017;&#26159;&#36755;&#20837;&#25490;&#38431;&#35268;&#21017;</span>
        <span style="color: #66D9EF;">int</span>             <span style="color: #FD971F;">padded</span>;
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc_ops</span>        *<span style="color: #FD971F;">ops</span>; <span style="color: #75715E;">//</span><span style="color: #75715E;">&#25490;&#38431;&#35268;&#21017;&#25552;&#20379;&#30340;&#25805;&#20316;&#25509;&#21475;</span>
        <span style="color: #66D9EF;">u32</span>             <span style="color: #FD971F;">handle</span>; <span style="color: #75715E;">//</span><span style="color: #75715E;">&#25490;&#38431;&#35268;&#21017;&#12289;&#31867;&#12289;&#36807;&#28388;&#22120;&#37117;&#26377;&#19968;&#20010;32&#20301;&#30340;&#21477;&#26564;</span>
        <span style="color: #66D9EF;">u32</span>             <span style="color: #FD971F;">parent</span>; <span style="color: #75715E;">//</span><span style="color: #75715E;">&#29238;&#33410;&#28857;&#21477;&#26564;</span>
        <span style="color: #66D9EF;">atomic_t</span>                <span style="color: #FD971F;">refcnt</span>; <span style="color: #75715E;">//</span><span style="color: #75715E;">&#24341;&#29992;&#35745;&#25968;</span>
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">sk_buff_head</span>     <span style="color: #FD971F;">q</span>; <span style="color: #75715E;">//</span><span style="color: #75715E;">&#38431;&#21015;&#20013;&#30340;&#25968;&#25454;&#21253;&#38142;&#34920;&#22836;</span>
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">net_device</span>       *<span style="color: #FD971F;">dev</span>; <span style="color: #75715E;">//</span><span style="color: #75715E;">&#25152;&#23646;&#32593;&#32476;&#35774;&#22791;</span>
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">list_head</span>        <span style="color: #FD971F;">list</span>; <span style="color: #75715E;">//</span><span style="color: #75715E;">&#29992;&#20110;&#38142;&#25509;&#21040;&#25152;&#37197;&#32622;&#30340;&#32593;&#32476;&#35774;&#22791;&#19978;</span>

        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">gnet_stats_basic</span> <span style="color: #FD971F;">bstats</span>; <span style="color: #75715E;">//</span><span style="color: #75715E;">&#20837;&#38431;&#25253;&#25991;&#32479;&#35745;</span>
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">gnet_stats_queue</span> <span style="color: #FD971F;">qstats</span>; <span style="color: #75715E;">//</span><span style="color: #75715E;">&#38431;&#21015;&#30340;&#32479;&#35745;&#25968;&#25454;</span>
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">gnet_stats_rate_est</span> <span style="color: #FD971F;">rate_est</span>; <span style="color: #75715E;">//</span><span style="color: #75715E;">&#38431;&#21015;&#30340;&#24403;&#21069;&#36895;&#29575;</span>
        <span style="color: #66D9EF;">spinlock_t</span>              *<span style="color: #FD971F;">stats_lock</span>;
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">rcu_head</span>         <span style="color: #FD971F;">q_rcu</span>;
        <span style="color: #66D9EF;">int</span>                     (*<span style="color: #A6E22E;">reshape_fail</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">sk_buff</span> *<span style="color: #FD971F;">skb</span>,<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *<span style="color: #FD971F;">q</span>);
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span>            *<span style="color: #FD971F;">__parent</span>;
};
</pre>
</div>
</div>
</div>

<div id="outline-container-org84a4b4f" class="outline-4">
<h4 id="org84a4b4f"><span class="section-number-4">2.1.2.</span> Qdisc_ops结构</h4>
<div class="outline-text-4" id="text-2-1-2">
<p>
Qdisc_ops结构用来描述队列操作的接口，每个排队规则都必须实现该接口。
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc_ops</span>
{
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc_ops</span>        *<span style="color: #FD971F;">next</span>; <span style="color: #75715E;">//</span><span style="color: #75715E;">&#29992;&#20110;&#38142;&#25509;&#24050;&#27880;&#20876;&#30340;&#21508;&#31181;&#25490;&#38431;&#35268;&#21017;&#25805;&#20316;&#25509;&#21475;</span>
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc_class_ops</span>  *<span style="color: #FD971F;">cl_ops</span>; <span style="color: #75715E;">//</span><span style="color: #75715E;">&#25552;&#20379;&#30340;&#31867;&#25805;&#20316;&#25509;&#21475;</span>
        <span style="color: #66D9EF;">char</span>                    <span style="color: #FD971F;">id</span>[IFNAMSIZ]; <span style="color: #75715E;">//</span><span style="color: #75715E;">&#20869;&#37096;&#26631;&#35782;&#31526;&#65292;&#36890;&#24120;&#26159;&#25490;&#38431;&#35268;&#21017;&#21517;</span>
        <span style="color: #66D9EF;">int</span>                     <span style="color: #FD971F;">priv_size</span>; <span style="color: #75715E;">//</span><span style="color: #75715E;">&#25490;&#38431;&#35268;&#21017;&#30340;&#31169;&#26377;&#20449;&#24687;&#22359;&#22823;&#23567;</span>
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#25968;&#25454;&#21253;&#30340;&#20837;&#38431;&#20989;&#25968;</span>
        <span style="color: #66D9EF;">int</span>               (*<span style="color: #A6E22E;">enqueue</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">sk_buff</span> *, <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *);
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#25968;&#25454;&#21253;&#30340;&#20986;&#38431;&#20989;&#25968;</span>
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">sk_buff</span> *        (*<span style="color: #A6E22E;">dequeue</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *);
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#20808;&#21069;&#20986;&#38431;&#25968;&#25454;&#21253;&#37325;&#26032;&#20837;&#38431;&#20989;&#25968;</span>
        <span style="color: #66D9EF;">int</span>               (*<span style="color: #A6E22E;">requeue</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">sk_buff</span> *, <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *);
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#20174;&#38431;&#21015;&#31227;&#38500;&#24182;&#20002;&#24323;&#25968;&#25454;&#21253;&#30340;&#20989;&#25968;</span>
        <span style="color: #66D9EF;">unsigned</span> <span style="color: #66D9EF;">int</span>    (*<span style="color: #A6E22E;">drop</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *);
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#21021;&#22987;&#21270;&#25490;&#38431;&#35268;&#21017;&#30340;&#20989;&#25968;</span>
        <span style="color: #66D9EF;">int</span>             (*<span style="color: #A6E22E;">init</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *, <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">rtattr</span> *<span style="color: #FD971F;">arg</span>);
        <span style="color: #66D9EF;">void</span>            (*<span style="color: #A6E22E;">reset</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *);
        <span style="color: #66D9EF;">void</span>            (*<span style="color: #A6E22E;">destroy</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *);
        <span style="color: #66D9EF;">int</span>             (*<span style="color: #A6E22E;">change</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *, <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">rtattr</span> *<span style="color: #FD971F;">arg</span>);
        <span style="color: #66D9EF;">int</span>             (*<span style="color: #A6E22E;">dump</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *, <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">sk_buff</span> *);
        <span style="color: #66D9EF;">int</span>             (*<span style="color: #A6E22E;">dump_stats</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *, <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">gnet_dump</span> *);
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">module</span>           *<span style="color: #FD971F;">owner</span>;
};
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcf9b22f" class="outline-4">
<h4 id="orgcf9b22f"><span class="section-number-4">2.1.3.</span> 排队规则相关函数</h4>
<div class="outline-text-4" id="text-2-1-3">
<ul class="org-ul">
<li>dev_init_scheduler() 用于初始化排队规则的相关数据，由register_netdevice()函数调用。</li>

<li>pktsched_init() 通过subsys_initcall宏添加到初始化列表，由系统初始化时调用，主要用于初始化 RT_NETLINK接口，并且调用 register_qdisc() 注册bfifo和pfifo排队规则。</li>

<li>register_qdisc() 将新的排队规则注册到系统中。</li>

<li>unregister_qdisc() 注销排队规则。</li>

<li>qdisc_look_ops() 根据排队规则名，查找已注册的排队规则。主要在创建规则时调用（qdisc_create()）。</li>

<li>qdisc_alloc()  分配内存，建立排队规则，并初始化排队规则相关成员，并和操作接口绑定，设置排队规则的enqueue和dequeue接口。</li>

<li>qdisc_create_dflt() 创建默认的排队规则。</li>

<li>qdisc_create() 创建指定排队规则。</li>

<li>qdisc_lookup() 根据排队规则句柄在网络设备上的排队规则中查找对应的排队规则。</li>

<li>dev_activate() 初始化排队规则</li>
</ul>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #66D9EF;">void</span> <span style="color: #A6E22E;">dev_activate</span>(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">net_device</span> *<span style="color: #FD971F;">dev</span>)
{
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#22914;&#26524;&#21892;&#20026;&#23433;&#35013;&#26377;&#25928;&#30340;&#25490;&#38431;&#35268;&#21017;&#65292;&#21017;&#23433;&#35013;&#40664;&#35748;&#25490;&#38431;&#35268;&#21017;</span>
        <span style="color: #F92672;">if</span> (dev-&gt;qdisc_sleeping == &amp;noop_qdisc) {
                <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *<span style="color: #FD971F;">qdisc</span>;
                <span style="color: #F92672;">if</span> (dev-&gt;tx_queue_len) {
                        qdisc = qdisc_create_dflt(dev, &amp;pfifo_fast_ops,
                                                  TC_H_ROOT);
                        <span style="color: #F92672;">if</span> (qdisc == <span style="color: #AE81FF;">NULL</span>) {
                                printk(KERN_INFO <span style="color: #E6DB74;">"%s: activation failed\n"</span>, dev-&gt;name);
                                <span style="color: #F92672;">return</span>;
                        }
                        write_lock(&amp;qdisc_tree_lock);
                        list_add_tail(&amp;qdisc-&gt;list, &amp;dev-&gt;qdisc_list);
                        write_unlock(&amp;qdisc_tree_lock);
                } <span style="color: #F92672;">else</span> {
                        qdisc =  &amp;noqueue_qdisc;
                }
                write_lock(&amp;qdisc_tree_lock);
                dev-&gt;qdisc_sleeping = qdisc;
                write_unlock(&amp;qdisc_tree_lock);
        }
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#32593;&#32476;&#35774;&#22791;&#26159;&#21542;&#22788;&#20110;&#21487;&#20256;&#36882;&#25968;&#25454;&#21253;&#29366;&#24577;</span>
        <span style="color: #F92672;">if</span> (<span style="color: #E6DB74; font-weight: bold;">!</span>netif_carrier_ok(dev))
                <span style="color: #75715E;">/* </span><span style="color: #75715E;">&#24310;&#36831;&#24212;&#29992;&#25490;&#38431;&#35268;&#21017;&#65292;&#30452;&#21040;&#21464;&#20026;&#21487;&#20256;&#36882;&#29366;&#24577;</span><span style="color: #75715E;"> */</span>
                <span style="color: #F92672;">return</span>;
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#24212;&#29992;&#25490;&#38431;&#35268;&#21017;</span>
        spin_lock_bh(&amp;dev-&gt;queue_lock);
        rcu_assign_pointer(dev-&gt;qdisc, dev-&gt;qdisc_sleeping);
        <span style="color: #F92672;">if</span> (dev-&gt;qdisc != &amp;noqueue_qdisc) {
                dev-&gt;trans_start = jiffies;
                dev_watchdog_up(dev);
        }
        spin_unlock_bh(&amp;dev-&gt;queue_lock);
}
</pre>
</div>

<ul class="org-ul">
<li>dev_deactivate() 将网络设备的排队规则设置为空规则，并停止发送报文。</li>
</ul>

<div class="org-src-container">
<pre class="src src-c">
<span style="color: #66D9EF;">void</span> <span style="color: #A6E22E;">dev_deactivate</span>(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">net_device</span> *<span style="color: #FD971F;">dev</span>)
{
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *<span style="color: #FD971F;">qdisc</span>;

        spin_lock_bh(&amp;dev-&gt;queue_lock);
        qdisc = dev-&gt;qdisc;
        dev-&gt;qdisc = &amp;noop_qdisc; <span style="color: #75715E;">//</span><span style="color: #75715E;">&#35774;&#32622;&#20026;&#31354;&#35268;&#21017;</span>
        qdisc_reset(qdisc); <span style="color: #75715E;">//</span><span style="color: #75715E;">&#37325;&#26032;&#21021;&#22987;&#21270;&#25490;&#38431;&#35268;&#21017;</span>
        spin_unlock_bh(&amp;dev-&gt;queue_lock);
        dev_watchdog_down(dev);
        <span style="color: #75715E;">/* </span><span style="color: #75715E;">&#35753;&#20986;&#22788;&#29702;&#22120;&#65292;&#21796;&#37266; dev_queue_xmit &#30340;&#25191;&#34892;&#36827;&#31243;</span><span style="color: #75715E;"> */</span>
        synchronize_rcu();
        <span style="color: #75715E;">/* </span><span style="color: #75715E;">&#32593;&#32476;&#35774;&#22791;&#36824;&#22788;&#20110;&#30041;&#24651;&#25511;&#21046;&#30340;&#35843;&#24230;&#38431;&#21015;&#36807;&#31243;&#20013;</span><span style="color: #75715E;"> */</span>
        <span style="color: #F92672;">while</span> (test_bit(__LINK_STATE_QDISC_RUNNING, &amp;dev-&gt;state))
                yield(); <span style="color: #75715E;">//</span><span style="color: #75715E;">&#35753;&#20986;&#22788;&#29702;&#22120;&#65292;&#23613;&#21487;&#33021;&#24555;&#36895;&#23436;&#25104;qdisc_run&#30340;&#35843;&#29992;</span>

        <span style="color: #F92672;">if</span> (dev-&gt;gso_skb) { <span style="color: #75715E;">//</span><span style="color: #75715E;">&#37322;&#25918;&#32531;&#23384;&#30340;gso&#25253;&#25991;</span>
                kfree_skb(dev-&gt;gso_skb);
                dev-&gt;gso_skb = <span style="color: #AE81FF;">NULL</span>;
        }
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org82c43bc" class="outline-3">
<h3 id="org82c43bc"><span class="section-number-3">2.2.</span> 类</h3>
<div class="outline-text-3" id="text-2-2">
</div>
<div id="outline-container-orgfcaeeff" class="outline-4">
<h4 id="orgfcaeeff"><span class="section-number-4">2.2.1.</span> xxx_class结构</h4>
<div class="outline-text-4" id="text-2-2-1">
<p>
每个类至少被绑定到一个过滤器。通过过滤器将报文分配到排队规则的不同类中。
</p>

<p>
由于各种类的实现存在着巨大差别，但是每个类都有一个与排队规则相似的唯一类标识符classid，用于标识一种类。
</p>

<p>
类的主编号对应与关联的排队规则，辅助编号指定该排队规则的类，辅编号的范围从0x0到0xFFFF，在单个排队规则中唯一。
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">xxx_class</span> {
        <span style="color: #66D9EF;">u32</span>  <span style="color: #FD971F;">classid</span>;
        <span style="color: #75715E;">//</span><span style="color: #75715E;">.......</span>
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">tcf_proto</span> *<span style="color: #FD971F;">filter_list</span>;
        <span style="color: #75715E;">//</span><span style="color: #75715E;">......</span>
};
</pre>
</div>
</div>
</div>


<div id="outline-container-orgf266f79" class="outline-4">
<h4 id="orgf266f79"><span class="section-number-4">2.2.2.</span> Qdisc_class_ops结构</h4>
<div class="outline-text-4" id="text-2-2-2">
<p>
Qdisc_class_ops结构是用于类操作的接口，排队规则如果要实现分类，就必须实现该接口。
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc_class_ops</span>
{
        <span style="color: #75715E;">/* </span><span style="color: #75715E;">Child qdisc manipulation</span><span style="color: #75715E;"> */</span>
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#29992;&#20110;&#23558;&#19968;&#20010;&#25490;&#38431;&#35268;&#21017;&#32465;&#23450;&#21040;&#19968;&#20010;&#31867;&#65292;&#24182;&#36820;&#22238;&#20808;&#21069;&#32465;&#23450;&#21040;&#36825;&#20010;&#31867;&#30340;&#25490;&#38431;&#35268;&#21017;</span>
        <span style="color: #66D9EF;">int</span>                     (*<span style="color: #A6E22E;">graft</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *, <span style="color: #66D9EF;">unsigned</span> <span style="color: #66D9EF;">long</span> <span style="color: #FD971F;">cl</span>,
                                        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *, <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> **);
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#33719;&#21462;&#24403;&#21069;&#32465;&#23450;&#21040;&#25152;&#22312;&#31867;&#30340;&#25490;&#38431;&#35268;&#21017;</span>
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *          (*<span style="color: #A6E22E;">leaf</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *, <span style="color: #66D9EF;">unsigned</span> <span style="color: #66D9EF;">long</span> <span style="color: #FD971F;">cl</span>);
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#29992;&#20110;&#21709;&#24212;&#38431;&#21015;&#38271;&#24230;&#30340;&#21464;&#21270;</span>
        <span style="color: #66D9EF;">void</span>                    (*<span style="color: #A6E22E;">qlen_notify</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *, <span style="color: #66D9EF;">unsigned</span> <span style="color: #66D9EF;">long</span>);

        <span style="color: #75715E;">/* </span><span style="color: #75715E;">Class manipulation routines</span><span style="color: #75715E;"> */</span>
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#32473;&#23450;&#31867;&#26631;&#35782;&#31526;&#65292;&#20174;&#25490;&#38431;&#35268;&#21017;&#33719;&#21462;&#24182;&#24341;&#29992;&#31867;</span>
        <span style="color: #66D9EF;">unsigned</span> <span style="color: #66D9EF;">long</span>           (*<span style="color: #A6E22E;">get</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *, <span style="color: #66D9EF;">u32</span> <span style="color: #FD971F;">classid</span>);
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#36882;&#20943;&#31867;&#30340;&#24341;&#29992;&#35745;&#25968;&#65292;&#20026;0&#26102;&#65292;&#37322;&#25918;&#31867;</span>
        <span style="color: #66D9EF;">void</span>                    (*<span style="color: #A6E22E;">put</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *, <span style="color: #66D9EF;">unsigned</span> <span style="color: #66D9EF;">long</span>);
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#29992;&#20110;&#21464;&#26356;&#25351;&#23450;&#31867;&#30340;&#21442;&#25968;&#65292;&#22914;&#26524;&#19981;&#23384;&#22312;&#21017;&#21019;&#24314;</span>
        <span style="color: #66D9EF;">int</span>                     (*<span style="color: #A6E22E;">change</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *, <span style="color: #66D9EF;">u32</span>, <span style="color: #66D9EF;">u32</span>,
                                        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">rtattr</span> **, <span style="color: #66D9EF;">unsigned</span> <span style="color: #66D9EF;">long</span> *);
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#29992;&#20110;&#21024;&#38500;&#24182;&#37322;&#25918;&#25351;&#23450;&#30340;&#31867;</span>
        <span style="color: #66D9EF;">int</span>                     (*<span style="color: #A6E22E;">delete</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *, <span style="color: #66D9EF;">unsigned</span> <span style="color: #66D9EF;">long</span>);
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#36941;&#21382;&#25490;&#38431;&#35268;&#21017;&#30340;&#25152;&#26377;&#31867;&#65292;&#24182;&#35843;&#29992;&#22238;&#35843;&#20989;&#25968;&#33719;&#21462;&#31867;&#30340;&#37197;&#32622;&#25968;&#25454;&#21450;&#32479;&#35745;&#20449;&#24687;</span>
        <span style="color: #66D9EF;">void</span>                    (*<span style="color: #A6E22E;">walk</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *, <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">qdisc_walker</span> * <span style="color: #FD971F;">arg</span>);

        <span style="color: #75715E;">/* </span><span style="color: #75715E;">Filter manipulation</span><span style="color: #75715E;"> */</span>
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#33719;&#21462;&#32465;&#23450;&#21040;&#35813;&#31867;&#30340;&#36807;&#28388;&#22120;&#25152;&#22312;&#38142;&#34920;&#30340;&#39318;&#32467;&#28857;&#12290;</span>
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">tcf_proto</span> **     (*<span style="color: #A6E22E;">tcf_chain</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *, <span style="color: #66D9EF;">unsigned</span> <span style="color: #66D9EF;">long</span>);
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#22312;&#36807;&#28388;&#22120;&#32465;&#23450;&#21040;&#25351;&#23450;&#31867;&#20043;&#21069;&#34987;&#35843;&#29992;</span>
        <span style="color: #66D9EF;">unsigned</span> <span style="color: #66D9EF;">long</span>           (*<span style="color: #A6E22E;">bind_tcf</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *, <span style="color: #66D9EF;">unsigned</span> <span style="color: #66D9EF;">long</span>,
                                        <span style="color: #66D9EF;">u32</span> <span style="color: #FD971F;">classid</span>);
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#36807;&#28388;&#22120;&#23436;&#25104;&#32465;&#23450;&#21040;&#25351;&#23450;&#31867;&#21518;&#34987;&#35843;&#29992;</span>
        <span style="color: #66D9EF;">void</span>                    (*<span style="color: #A6E22E;">unbind_tcf</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *, <span style="color: #66D9EF;">unsigned</span> <span style="color: #66D9EF;">long</span>);

        <span style="color: #75715E;">/* </span><span style="color: #75715E;">rtnetlink specific</span><span style="color: #75715E;"> */</span>
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#29992;&#20110;&#36755;&#20986;&#31867;&#30340;&#37197;&#32622;&#21442;&#25968;&#21644;&#32479;&#35745;&#20449;&#24687;</span>
        <span style="color: #66D9EF;">int</span>                     (*<span style="color: #A6E22E;">dump</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *, <span style="color: #66D9EF;">unsigned</span> <span style="color: #66D9EF;">long</span>,
                                        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">sk_buff</span> *<span style="color: #FD971F;">skb</span>, <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">tcmsg</span>*);
        <span style="color: #66D9EF;">int</span>                     (*<span style="color: #A6E22E;">dump_stats</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *, <span style="color: #66D9EF;">unsigned</span> <span style="color: #66D9EF;">long</span>,
                                        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">gnet_dump</span> *);
};
</pre>
</div>
</div>
</div>


<div id="outline-container-orga391bbc" class="outline-4">
<h4 id="orga391bbc"><span class="section-number-4">2.2.3.</span> 类的相关函数</h4>
<div class="outline-text-4" id="text-2-2-3">
<ul class="org-ul">
<li>qdisc_graft() 用于将一个排队规则绑定到一个类，并返回先前绑定到这个类的排队规则。</li>
</ul>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #F92672;">static</span> <span style="color: #66D9EF;">int</span> <span style="color: #A6E22E;">qdisc_graft</span>(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">net_device</span> *<span style="color: #FD971F;">dev</span>, <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *<span style="color: #FD971F;">parent</span>,
                       <span style="color: #66D9EF;">u32</span> <span style="color: #FD971F;">classid</span>,
                       <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *<span style="color: #FD971F;">new</span>, <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> **<span style="color: #FD971F;">old</span>)
{
        <span style="color: #66D9EF;">int</span> <span style="color: #FD971F;">err</span> = 0;
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *<span style="color: #FD971F;">q</span> = *old;
        <span style="color: #F92672;">if</span> (parent == <span style="color: #AE81FF;">NULL</span>) {<span style="color: #75715E;">//</span><span style="color: #75715E;">&#27809;&#26377;&#29238;&#32467;&#28857;&#65292;&#21017;&#26159;&#26681;&#32467;&#28857;</span>
                <span style="color: #F92672;">if</span> (q &amp;&amp; q-&gt;flags&amp;TCQ_F_INGRESS) {
                        *old = dev_graft_qdisc(dev, q);
                } <span style="color: #F92672;">else</span> {
                        *old = dev_graft_qdisc(dev, new);
                }
        } <span style="color: #F92672;">else</span> {
                <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc_class_ops</span> *<span style="color: #FD971F;">cops</span> = parent-&gt;ops-&gt;cl_ops;
                err = -EINVAL;
                <span style="color: #F92672;">if</span> (cops) {
                        <span style="color: #66D9EF;">unsigned</span> <span style="color: #66D9EF;">long</span> <span style="color: #FD971F;">cl</span> = cops-&gt;get(parent, classid);
                        <span style="color: #F92672;">if</span> (cl) {
                                <span style="color: #75715E;">//</span><span style="color: #75715E;">&#23558;&#25490;&#38431;&#35268;&#21017;&#32465;&#23450;&#21040;&#31867;</span>
                                err = cops-&gt;graft(parent, cl, new, old);
                                <span style="color: #F92672;">if</span> (new)
                                        new-&gt;parent = classid;
                                cops-&gt;put(parent, cl);
                        }
                }
        }
        <span style="color: #F92672;">return</span> err;
}
</pre>
</div>

<ul class="org-ul">
<li>dev_graft_qdisc() 为网络设备安装指定的根排队规则</li>
</ul>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #F92672;">static</span> <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *
<span style="color: #A6E22E;">dev_graft_qdisc</span>(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">net_device</span> *<span style="color: #FD971F;">dev</span>, <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *<span style="color: #FD971F;">qdisc</span>)
{
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *<span style="color: #FD971F;">oqdisc</span>;
        <span style="color: #F92672;">if</span> (dev-&gt;flags &amp; IFF_UP)
                dev_deactivate(dev); <span style="color: #75715E;">//</span><span style="color: #75715E;">&#23558;&#25490;&#38431;&#35268;&#21017;&#35774;&#32622;&#20026;&#31354;&#25490;&#38431;&#35268;&#21017;&#65292;&#24182;&#20572;&#27490;&#21457;&#36865;&#25253;&#25991;</span>
        qdisc_lock_tree(dev);
        <span style="color: #F92672;">if</span> (qdisc &amp;&amp; qdisc-&gt;flags&amp;TCQ_F_INGRESS) {<span style="color: #75715E;">//</span><span style="color: #75715E;">&#36755;&#20837;&#25490;&#38431;&#35268;&#21017;</span>
                oqdisc = dev-&gt;qdisc_ingress;
                <span style="color: #F92672;">if</span> (oqdisc &amp;&amp; atomic_read(&amp;oqdisc-&gt;refcnt) &lt;= 1) {
                        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#21024;&#38500;&#25490;&#38431;&#35268;&#21017;</span>
                        qdisc_reset(oqdisc);
                        dev-&gt;qdisc_ingress = <span style="color: #AE81FF;">NULL</span>;
                } <span style="color: #F92672;">else</span> {  <span style="color: #75715E;">//</span><span style="color: #75715E;">&#23433;&#35013;&#26032;&#30340;&#25490;&#38431;&#35268;&#21017;</span>
                        dev-&gt;qdisc_ingress = qdisc;
                }
        } <span style="color: #F92672;">else</span> { <span style="color: #75715E;">//</span><span style="color: #75715E;">&#36755;&#20986;&#25490;&#38431;&#35268;&#21017;</span>
                oqdisc = dev-&gt;qdisc_sleeping;
                <span style="color: #75715E;">//</span><span style="color: #75715E;">&#21021;&#22987;&#21270;&#24403;&#21069;&#30340;&#36755;&#20986;&#25490;&#38431;&#35268;&#21017;</span>
                <span style="color: #F92672;">if</span> (oqdisc &amp;&amp; atomic_read(&amp;oqdisc-&gt;refcnt) &lt;= 1)
                        qdisc_reset(oqdisc);

                <span style="color: #75715E;">//</span><span style="color: #75715E;">&#23433;&#35013;&#26032;&#30340;&#25490;&#38431;&#35268;&#21017;</span>
                <span style="color: #F92672;">if</span> (qdisc == <span style="color: #AE81FF;">NULL</span>)
                        qdisc = &amp;noop_qdisc;
                dev-&gt;qdisc_sleeping = qdisc;
                dev-&gt;qdisc = &amp;noop_qdisc;<span style="color: #75715E;">//</span><span style="color: #75715E;">&#23558;&#24403;&#21069;&#25490;&#38431;&#35268;&#21017;&#35774;&#32622;&#20026;&#31354;&#35268;&#21017;</span>
        }
        qdisc_unlock_tree(dev);
        <span style="color: #F92672;">if</span> (dev-&gt;flags &amp; IFF_UP)
                dev_activate(dev);<span style="color: #75715E;">//</span><span style="color: #75715E;">&#24212;&#29992;&#19978;&#38754;&#23433;&#35013;&#30340;&#25490;&#38431;&#35268;&#21017;&#65288;qdisc_sleeping&#65289;</span>
        <span style="color: #F92672;">return</span> oqdisc;
}
</pre>
</div>

<ul class="org-ul">
<li>qdisc_leaf() 根据父结点和类标识符，获取当前绑定到所在类的排队规则。</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org9d2dc82" class="outline-3">
<h3 id="org9d2dc82"><span class="section-number-3">2.3.</span> 过滤器</h3>
<div class="outline-text-3" id="text-2-3">
<p>
当报文被送到一个具有多个类的排队规则时，排队规则将调用tc_classify()。
</p>

<p>
tc_classify() 首先检查过滤器是否接受skb-&gt;protol所指定的协议，然后调用过滤器的classify()做出决定是否接受或者分到哪个类中。
</p>
</div>

<div id="outline-container-org030b6af" class="outline-4">
<h4 id="org030b6af"><span class="section-number-4">2.3.1.</span> tcf_proto结构</h4>
<div class="outline-text-4" id="text-2-3-1">
<p>
过滤器的结构是tcf_proto。
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">tcf_proto</span>
{
        <span style="color: #75715E;">/* </span><span style="color: #75715E;">Fast access part</span><span style="color: #75715E;"> */</span>
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">tcf_proto</span>        *<span style="color: #FD971F;">next</span>; <span style="color: #75715E;">//</span><span style="color: #75715E;">&#29992;&#20110;&#38142;&#25509;&#22810;&#20010;&#36807;&#28388;&#22120;&#30340;&#38142;&#34920;&#20803;&#32032;</span>
        <span style="color: #66D9EF;">void</span>                    *<span style="color: #FD971F;">root</span>;
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#25253;&#25991;&#20998;&#31867;&#20989;&#25968;</span>
        <span style="color: #66D9EF;">int</span>                     (*<span style="color: #A6E22E;">classify</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">sk_buff</span>*, <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">tcf_proto</span>*,
                                        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">tcf_result</span> *);
        <span style="color: #66D9EF;">__be16</span>                  <span style="color: #FD971F;">protocol</span>;<span style="color: #75715E;">//</span><span style="color: #75715E;">&#32593;&#32476;&#23618;&#21327;&#35758;&#21495;</span>
        <span style="color: #75715E;">/* </span><span style="color: #75715E;">All the rest</span><span style="color: #75715E;"> */</span>
        <span style="color: #66D9EF;">u32</span>                     <span style="color: #FD971F;">prio</span>; <span style="color: #75715E;">//</span><span style="color: #75715E;">&#20248;&#20808;&#32423;</span>
        <span style="color: #66D9EF;">u32</span>                     <span style="color: #FD971F;">classid</span>; <span style="color: #75715E;">//</span><span style="color: #75715E;">&#29238;&#25490;&#38431;&#35268;&#21017;&#30340;&#31867;&#26631;&#35782;&#31526;</span>
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span>            *<span style="color: #FD971F;">q</span>; <span style="color: #75715E;">//</span><span style="color: #75715E;">&#29238;&#25490;&#38431;&#35268;&#21017;</span>
        <span style="color: #66D9EF;">void</span>                    *<span style="color: #FD971F;">data</span>; <span style="color: #75715E;">//</span><span style="color: #75715E;">&#23384;&#20648;&#29305;&#23450;&#36807;&#28388;&#22120;&#30340;&#25968;&#25454;</span>
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">tcf_proto_ops</span>    *<span style="color: #FD971F;">ops</span>; <span style="color: #75715E;">//</span><span style="color: #75715E;">&#36807;&#28388;&#22120;&#23545;&#24212;&#30340;&#25805;&#20316;&#25509;&#21475;</span>
};
</pre>
</div>
</div>
</div>


<div id="outline-container-org6fc02ed" class="outline-4">
<h4 id="org6fc02ed"><span class="section-number-4">2.3.2.</span> tcf_proto_ops结构</h4>
<div class="outline-text-4" id="text-2-3-2">
<p>
tcf_proto_ops是用来描述过滤器的结构，如果排队规则实现了分类，则必须实现过滤器来进行分类。
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">tcf_proto_ops</span>
{
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">tcf_proto_ops</span>    *<span style="color: #FD971F;">next</span>; <span style="color: #75715E;">//</span><span style="color: #75715E;">&#29992;&#20110;&#38142;&#25509;&#24050;&#27880;&#20876;&#36807;&#28388;&#22120;&#30340;&#38142;&#34920;&#20803;&#32032;&#65288;tcf_proto_base&#65289;</span>
        <span style="color: #66D9EF;">char</span>                    <span style="color: #FD971F;">kind</span>[IFNAMSIZ];<span style="color: #75715E;">//</span><span style="color: #75715E;">&#36807;&#28388;&#22120;&#26631;&#35782;&#31526;&#65292;&#36890;&#24120;&#20026;&#36807;&#28388;&#22120;&#21517;</span>
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#25253;&#25991;&#20998;&#31867;&#20989;&#25968;</span>
        <span style="color: #66D9EF;">int</span>                     (*<span style="color: #A6E22E;">classify</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">sk_buff</span>*, <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">tcf_proto</span>*, <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">tcf_result</span> *);
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#36807;&#28388;&#22120;&#21021;&#22987;&#21270;&#20989;&#25968;&#65292;&#36890;&#24120;&#22312;&#21019;&#24314;&#36807;&#28388;&#22120;&#20043;&#21518;&#35843;&#29992;</span>
        <span style="color: #66D9EF;">int</span>                     (*<span style="color: #A6E22E;">init</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">tcf_proto</span>*);
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#37322;&#25918;&#36807;&#28388;&#22120;</span>
        <span style="color: #66D9EF;">void</span>                    (*<span style="color: #A6E22E;">destroy</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">tcf_proto</span>*);
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#23558;&#36807;&#28388;&#22120;&#21477;&#26564;&#26144;&#23556;&#20026;&#36807;&#28388;&#22120;&#30340;&#20869;&#37096;&#26631;&#35782;&#31526;</span>
        <span style="color: #66D9EF;">unsigned</span> <span style="color: #66D9EF;">long</span>           (*<span style="color: #A6E22E;">get</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">tcf_proto</span>*, <span style="color: #66D9EF;">u32</span> <span style="color: #FD971F;">handle</span>);
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#35299;&#38500;get&#24471;&#21040;&#30340;&#36807;&#28388;&#22120;&#30340;&#24341;&#29992;</span>
        <span style="color: #66D9EF;">void</span>                    (*<span style="color: #A6E22E;">put</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">tcf_proto</span>*, <span style="color: #66D9EF;">unsigned</span> <span style="color: #66D9EF;">long</span>);
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#29992;&#20110;&#37197;&#32622;&#26032;&#30340;&#36807;&#28388;&#22120;&#25110;&#32773;&#21464;&#26356;&#19968;&#20010;&#24050;&#23384;&#22312;&#30340;&#36807;&#28388;&#22120;&#30340;&#37197;&#32622;</span>
        <span style="color: #66D9EF;">int</span>                     (*<span style="color: #A6E22E;">change</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">tcf_proto</span>*, <span style="color: #66D9EF;">unsigned</span> <span style="color: #66D9EF;">long</span>,
                                        <span style="color: #66D9EF;">u32</span> <span style="color: #FD971F;">handle</span>, <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">rtattr</span> **,
                                        <span style="color: #66D9EF;">unsigned</span> <span style="color: #66D9EF;">long</span> *);
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#21024;&#38500;&#36807;&#28388;&#22120;&#30340;&#20803;&#32032;&#65292;&#36807;&#28388;&#22120;&#20869;&#37096;&#20998;&#31163;&#20026;&#36807;&#28388;&#22120;&#20803;&#32032;&#65292;&#36890;&#36807;u32&#31867;&#22411;&#30340;&#21477;&#26564;&#26631;&#35782;&#20869;&#37096;&#20803;&#32032;&#12290;</span>
        <span style="color: #66D9EF;">int</span>                     (*<span style="color: #A6E22E;">delete</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">tcf_proto</span>*, <span style="color: #66D9EF;">unsigned</span> <span style="color: #66D9EF;">long</span>);
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#36941;&#21382;&#36807;&#28388;&#22120;&#25152;&#26377;&#20803;&#32032;&#65292;&#24182;&#35843;&#29992;&#22238;&#35843;&#20989;&#25968;&#33719;&#21462;&#37197;&#32622;&#25968;&#25454;&#21644;&#32479;&#35745;&#25968;&#25454;</span>
        <span style="color: #66D9EF;">void</span>                    (*<span style="color: #A6E22E;">walk</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">tcf_proto</span>*, <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">tcf_walker</span> *<span style="color: #FD971F;">arg</span>);
        <span style="color: #75715E;">/* </span><span style="color: #75715E;">rtnetlink specific</span><span style="color: #75715E;"> */</span>
        <span style="color: #66D9EF;">int</span>                     (*<span style="color: #A6E22E;">dump</span>)(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">tcf_proto</span>*, <span style="color: #66D9EF;">unsigned</span> <span style="color: #66D9EF;">long</span>,
                                        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">sk_buff</span> *<span style="color: #FD971F;">skb</span>, <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">tcmsg</span>*);
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">module</span>           *<span style="color: #FD971F;">owner</span>;
};

<span style="color: #75715E;">//</span><span style="color: #75715E;">chassify()&#30340;&#36755;&#20986;&#21442;&#25968;</span>
<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">tcf_result</span> {
        <span style="color: #66D9EF;">unsigned</span> <span style="color: #66D9EF;">long</span>   <span style="color: #FD971F;">class</span>;
        <span style="color: #66D9EF;">u32</span>             <span style="color: #FD971F;">classid</span>;
};
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 1:</span> classify的返回值</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">返回值</th>
<th scope="col" class="org-left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">TC_POLICE_UNSPEC</td>
<td class="org-left">不匹配，送到下个过滤器或者元素</td>
</tr>

<tr>
<td class="org-left">TC_POLICE_OK</td>
<td class="org-left">报文被过滤器接收</td>
</tr>

<tr>
<td class="org-left">TC_POLICE_RECLASSIFY</td>
<td class="org-left">违背合法参数，应该分配到一个不同的类</td>
</tr>

<tr>
<td class="org-left">TC_POLICE_SHOT</td>
<td class="org-left">被过滤器接收，但是过滤器又将其丢弃</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgc2c8c86" class="outline-4">
<h4 id="orgc2c8c86"><span class="section-number-4">2.3.3.</span> 过滤器相关函数</h4>
<div class="outline-text-4" id="text-2-3-3">
<ul class="org-ul">
<li>tc_filter_init() 初始化过滤器的创建、删除操作的netlink接口</li>

<li>register_tcf_proto_ops() 将过滤器注册到系统过滤器链表 tcf_proto_base 中。</li>

<li>unregister_tcf_proto_ops() 注销过滤器</li>

<li>tcf_proto_lookup_ops() 根据过滤器名，获取过滤器</li>
</ul>
</div>
</div>
</div>
</div>


<div id="outline-container-orgd8dd161" class="outline-2">
<h2 id="orgd8dd161"><span class="section-number-2">3.</span> 默认的FIFO排队规则</h2>
<div class="outline-text-2" id="text-3">
<p>
Linux默认排队规则是FIFO（先进先出）排队规则。该排队规则内部有三个队列，0优先级最高，之后是1、2。
</p>

<p>
进入FIFO排队规则时，根据数据包的TOS标记，将带有最小延迟标记的数据包排入0队列。
</p>


<div id="orgd3c7abe" class="figure">
<p><img src="image/qos/tos-val.png" alt="tos-val.png" />
</p>
<p><span class="figure-number">Figure 3: </span>TOS字段的取值</p>
</div>


<div id="org8905d34" class="figure">
<p><img src="image/qos/tos-queue.png" alt="tos-queue.png" />
</p>
<p><span class="figure-number">Figure 4: </span>TOS字段与队列</p>
</div>


<p>
FIFO排队规则的操作接口为pfifo_fast_ops:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #F92672;">static</span> <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc_ops</span> <span style="color: #FD971F;">pfifo_fast_ops</span> = {
        .id             =       <span style="color: #E6DB74;">"pfifo_fast"</span>,
        .priv_size      =       PFIFO_FAST_BANDS * <span style="color: #F92672;">sizeof</span>(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">sk_buff_head</span>),
        .enqueue        =       pfifo_fast_enqueue,
        .dequeue        =       pfifo_fast_dequeue,
        .requeue        =       pfifo_fast_requeue,
        .init           =       pfifo_fast_init,
        .reset  =       pfifo_fast_reset,
        .dump           =       pfifo_fast_dump,
        .owner  =       THIS_MODULE,
};
</pre>
</div>

<p>
FIFO排队规则没有类和过滤器，Qdisc实例的操作接口指向pfifo_fast_ops, 尾部的私有信息中只是三个队列：
</p>

<div id="orgdbb9c87" class="figure">
<p><img src="image/qos/fifo-queue.png" alt="fifo-queue.png" />
</p>
<p><span class="figure-number">Figure 5: </span>FIFO排队规则的数据组织结构</p>
</div>
</div>


<div id="outline-container-org823283b" class="outline-3">
<h3 id="org823283b"><span class="section-number-3">3.1.</span> pfifo_fast_init</h3>
<div class="outline-text-3" id="text-3-1">
<p>
FIFO排队规则的初始化函数。
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #F92672;">static</span> <span style="color: #66D9EF;">int</span> <span style="color: #A6E22E;">pfifo_fast_init</span>(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *<span style="color: #FD971F;">qdisc</span>, <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">rtattr</span> *<span style="color: #FD971F;">opt</span>)
{
        <span style="color: #66D9EF;">int</span> <span style="color: #FD971F;">prio</span>;
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">sk_buff_head</span> *<span style="color: #FD971F;">list</span> = qdisc_priv(qdisc);
        <span style="color: #F92672;">for</span> (prio = 0; prio &lt; PFIFO_FAST_BANDS; prio++)
                skb_queue_head_init(list + prio);
        <span style="color: #F92672;">return</span> 0;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc0fac01" class="outline-3">
<h3 id="orgc0fac01"><span class="section-number-3">3.2.</span> pfifo_fast_reset()</h3>
<div class="outline-text-3" id="text-3-2">
<p>
将排队规则恢复到初始化状态。
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #F92672;">static</span> <span style="color: #66D9EF;">void</span> <span style="color: #A6E22E;">pfifo_fast_reset</span>(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span>* <span style="color: #FD971F;">qdisc</span>)
{
        <span style="color: #66D9EF;">int</span> <span style="color: #FD971F;">prio</span>;
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">sk_buff_head</span> *<span style="color: #FD971F;">list</span> = qdisc_priv(qdisc);
        <span style="color: #F92672;">for</span> (prio = 0; prio &lt; PFIFO_FAST_BANDS; prio++)
                __qdisc_reset_queue(qdisc, list + prio);
        qdisc-&gt;qstats.backlog = 0;
        qdisc-&gt;q.qlen = 0;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org2c52c48" class="outline-3">
<h3 id="org2c52c48"><span class="section-number-3">3.3.</span> pfifo_fast_enqueue()</h3>
<div class="outline-text-3" id="text-3-3">
<p>
FIFO的入对函数。
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #F92672;">static</span> <span style="color: #66D9EF;">int</span> <span style="color: #A6E22E;">pfifo_fast_enqueue</span>(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">sk_buff</span> *<span style="color: #FD971F;">skb</span>, <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span>* <span style="color: #FD971F;">qdisc</span>)
{
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">sk_buff_head</span> *<span style="color: #FD971F;">list</span> = prio2list(skb, qdisc);
        <span style="color: #F92672;">if</span> (skb_queue_len(list) &lt; qdisc-&gt;dev-&gt;tx_queue_len) {<span style="color: #75715E;">//</span><span style="color: #75715E;">&#26159;&#21542;&#36798;&#21040;&#25968;&#25454;&#21253;&#19978;&#38480;</span>
                qdisc-&gt;q.qlen++;
                <span style="color: #F92672;">return</span> __qdisc_enqueue_tail(skb, qdisc, list);
        }
        <span style="color: #F92672;">return</span> qdisc_drop(skb, qdisc);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc6668b4" class="outline-3">
<h3 id="orgc6668b4"><span class="section-number-3">3.4.</span> pfifo_fast_dequeue()</h3>
<div class="outline-text-3" id="text-3-4">
<div class="org-src-container">
<pre class="src src-c">
<span style="color: #F92672;">static</span> <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">sk_buff</span> *<span style="color: #A6E22E;">pfifo_fast_dequeue</span>(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span>* <span style="color: #FD971F;">qdisc</span>)
{
        <span style="color: #66D9EF;">int</span> <span style="color: #FD971F;">prio</span>;
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">sk_buff_head</span> *<span style="color: #FD971F;">list</span> = qdisc_priv(qdisc);
        <span style="color: #F92672;">for</span> (prio = 0; prio &lt; PFIFO_FAST_BANDS; prio++) {
                <span style="color: #F92672;">if</span> (<span style="color: #E6DB74; font-weight: bold;">!</span>skb_queue_empty(list + prio)) {
                        qdisc-&gt;q.qlen--;
                        <span style="color: #F92672;">return</span> __qdisc_dequeue_head(qdisc, list + prio);
                }
        }
        <span style="color: #F92672;">return</span> <span style="color: #AE81FF;">NULL</span>;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc7a4704" class="outline-3">
<h3 id="orgc7a4704"><span class="section-number-3">3.5.</span> pfifo_fast_requeue()</h3>
<div class="outline-text-3" id="text-3-5">
<p>
报文由于发送而出队，但是又因为其他原因没有发送，此时需要重新入队。
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #F92672;">static</span> <span style="color: #66D9EF;">int</span> <span style="color: #A6E22E;">pfifo_fast_requeue</span>(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">sk_buff</span> *<span style="color: #FD971F;">skb</span>, <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span>* <span style="color: #FD971F;">qdisc</span>)
{
        qdisc-&gt;q.qlen++;
        <span style="color: #F92672;">return</span> __qdisc_requeue(skb, qdisc, prio2list(skb, qdisc));
}
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-orgf7d3e52" class="outline-2">
<h2 id="orgf7d3e52"><span class="section-number-2">4.</span> netlink的tc接口</h2>
<div class="outline-text-2" id="text-4">

<div id="orgc759e39" class="figure">
<p><img src="image/qos/netlink-api.png" alt="netlink-api.png" />
</p>
<p><span class="figure-number">Figure 6: </span>netlink接口</p>
</div>




<div id="orgff095ad" class="figure">
<p><img src="image/qos/netlink-msg.png" alt="netlink-msg.png" />
</p>
<p><span class="figure-number">Figure 7: </span>流量控制中的netlink消息</p>
</div>

<ul class="org-ul">
<li>Family,  8位，绑定的地址族</li>
<li>Interface Index, 32位，网络设备索引</li>
<li>Qdisc handle, 32位，排队规则句柄</li>
<li>Parent Qdisc, 32位，父排队规则句柄</li>
<li>TCM Info, 32位，对于排队规则，通常为1; 对于类，则是要绑定排队规则的句柄; 对于过滤器，高16位为优先级，低16位为网络层协议号。</li>
<li>扩展属性
<ul class="org-ul">
<li>TCA_KIND 组件名称</li>
<li>TCA_OPTIONS  特定属性</li>
<li>TCA_STATS  一般性的统计信息</li>
<li>TCA_XSTATS 特定统计信息</li>
<li>TCA_RATE  用来计算速率的统计信息快照</li>
</ul></li>
</ul>


<p>
以下是一个简单示例：当队列中的缓存报文超过100时，丢弃后续的报文，网络设备索引为0，父排队规则 100:0， 排队规则句柄 100:1。
</p>


<div id="org2c4861b" class="figure">
<p><img src="image/qos/netlink-msg-obj.png" alt="netlink-msg-obj.png" />
</p>
<p><span class="figure-number">Figure 8: </span>配置流量控制的例子</p>
</div>
</div>
</div>


<div id="outline-container-org3ca10bd" class="outline-2">
<h2 id="org3ca10bd"><span class="section-number-2">5.</span> 排队规则的创建接口</h2>
<div class="outline-text-2" id="text-5">
<p>
通过tc工具创建排队规则时， 最终由 tc_modify_qdisc() 来处理。
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #F92672;">static</span> <span style="color: #66D9EF;">int</span> <span style="color: #A6E22E;">tc_modify_qdisc</span>(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">sk_buff</span> *<span style="color: #FD971F;">skb</span>, <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">nlmsghdr</span> *<span style="color: #FD971F;">n</span>, <span style="color: #66D9EF;">void</span> *<span style="color: #FD971F;">arg</span>)
{
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">tcmsg</span> *<span style="color: #FD971F;">tcm</span>;
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">rtattr</span> **<span style="color: #FD971F;">tca</span>;
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">net_device</span> *<span style="color: #FD971F;">dev</span>;
        <span style="color: #66D9EF;">u32</span> <span style="color: #FD971F;">clid</span>;
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *<span style="color: #FD971F;">q</span>, *<span style="color: #FD971F;">p</span>;
        <span style="color: #66D9EF;">int</span> <span style="color: #FD971F;">err</span>;

<span style="color: #AE81FF;">replay</span>:
        <span style="color: #75715E;">/* </span><span style="color: #75715E;">Reinit, just in case something touches this.</span><span style="color: #75715E;"> */</span>
        tcm = NLMSG_DATA(n); <span style="color: #75715E;">//</span><span style="color: #75715E;">&#36716;&#21270;&#20026;&#27969;&#37327;&#25511;&#21046;&#28040;&#24687;</span>
        tca = arg;
        clid = tcm-&gt;tcm_parent;
        q = p = <span style="color: #AE81FF;">NULL</span>;
        <span style="color: #F92672;">if</span> ((dev = __dev_get_by_index(tcm-&gt;tcm_ifindex)) == <span style="color: #AE81FF;">NULL</span>) <span style="color: #75715E;">//</span><span style="color: #75715E;">&#33719;&#21462;&#32593;&#32476;&#35774;&#22791;</span>
                <span style="color: #F92672;">return</span> -ENODEV;
        <span style="color: #F92672;">if</span> (clid) { <span style="color: #75715E;">//</span><span style="color: #75715E;">&#23384;&#22312;&#29238;&#25490;&#38431;&#35268;&#21017;&#30340;&#24773;&#20917;</span>
                <span style="color: #F92672;">if</span> (clid != TC_H_ROOT) {<span style="color: #75715E;">//</span><span style="color: #75715E;">&#29238;&#25490;&#38431;&#35268;&#21017;&#19981;&#26159;&#26681;&#25490;&#38431;&#35268;&#21017;</span>
                        <span style="color: #F92672;">if</span> (clid != TC_H_INGRESS) { <span style="color: #75715E;">//</span><span style="color: #75715E;">&#36755;&#20986;&#25490;&#38431;&#35268;&#21017;</span>
                                <span style="color: #F92672;">if</span> ((p = qdisc_lookup(dev, TC_H_MAJ(clid))) == <span style="color: #AE81FF;">NULL</span>)
                                        <span style="color: #F92672;">return</span> -ENOENT;
                                q = qdisc_leaf(p, clid);
                        } <span style="color: #F92672;">else</span> { <span style="color: #75715E;">/*</span><span style="color: #75715E;">ingress</span><span style="color: #75715E;"> */</span>
                                q = dev-&gt;qdisc_ingress;
                        }
                } <span style="color: #F92672;">else</span> {<span style="color: #75715E;">//</span><span style="color: #75715E;">&#29238;&#25490;&#38431;&#35268;&#21017;&#26159;&#26681;&#25490;&#38431;&#35268;&#21017;&#65292;&#21017;&#33719;&#21462;&#35774;&#22791;&#30340;qdisc_sleeping</span>
                        q = dev-&gt;qdisc_sleeping;
                }

                <span style="color: #75715E;">/* </span><span style="color: #75715E;">&#22914;&#26524;&#26159;&#40664;&#35748;&#25490;&#38431;&#35268;&#21017;&#65292;&#21017;&#35748;&#20026;&#24403;&#21069;&#26410;&#37197;&#32622;&#25490;&#38431;&#35268;&#21017;</span><span style="color: #75715E;"> */</span>
                <span style="color: #F92672;">if</span> (q &amp;&amp; q-&gt;handle == 0)
                        q = <span style="color: #AE81FF;">NULL</span>;
                <span style="color: #75715E;">//</span><span style="color: #75715E;">&#24403;&#21069;&#26410;&#37197;&#32622;&#25490;&#38431;&#35268;&#21017; &#25110;&#32773;&#26410;&#25351;&#23450;&#24453;&#21019;&#24314;&#25490;&#38431;&#35268;&#21017;&#30340;&#21477;&#26564; &#25110;&#32773;&#25351;&#23450;&#25490;&#38431;&#35268;&#21017;&#21477;&#26564;&#19981;&#21305;&#37197;</span>
                <span style="color: #F92672;">if</span> (<span style="color: #E6DB74; font-weight: bold;">!</span>q || <span style="color: #E6DB74; font-weight: bold;">!</span>tcm-&gt;tcm_handle || q-&gt;handle != tcm-&gt;tcm_handle) {
                        <span style="color: #F92672;">if</span> (tcm-&gt;tcm_handle) { <span style="color: #75715E;">//</span><span style="color: #75715E;">&#25351;&#23450;&#20102;&#37197;&#32622;&#25490;&#38431;&#35268;&#21017;&#30340;&#21477;&#26564;</span>
                                <span style="color: #75715E;">//</span><span style="color: #75715E;">&#24050;&#32463;&#37197;&#32622;&#25490;&#38431;&#35268;&#21017;&#65292;&#20294;&#27809;&#26377;&#35774;&#32622;&#21487;&#26367;&#25442;&#26631;&#24535;</span>
                                <span style="color: #F92672;">if</span> (q &amp;&amp; <span style="color: #E6DB74; font-weight: bold;">!</span>(n-&gt;nlmsg_flags&amp;NLM_F_REPLACE))
                                        <span style="color: #F92672;">return</span> -EEXIST;
                                <span style="color: #75715E;">//</span><span style="color: #75715E;">&#25351;&#23450;&#20102;&#25490;&#38431;&#35268;&#21017;&#21477;&#26564;&#30340;&#24133;&#32534;&#21495;</span>
                                <span style="color: #F92672;">if</span> (TC_H_MIN(tcm-&gt;tcm_handle))
                                        <span style="color: #F92672;">return</span> -EINVAL;
                                <span style="color: #75715E;">//</span><span style="color: #75715E;">&#36890;&#36807;&#21477;&#26564;&#26597;&#25214;&#25490;&#38431;&#35268;&#21017;&#65292;&#27809;&#26377;&#25214;&#21040;&#21017;&#21019;&#24314;</span>
                                <span style="color: #F92672;">if</span> ((q = qdisc_lookup(dev, tcm-&gt;tcm_handle)) == <span style="color: #AE81FF;">NULL</span>)
                                        <span style="color: #F92672;">goto</span> <span style="color: #AE81FF;">create_n_graft</span>;
                                <span style="color: #75715E;">//</span><span style="color: #75715E;">&#25214;&#21040;&#25490;&#38431;&#35268;&#21017;&#65292;&#19988;&#35774;&#32622;&#20102;NLM_F_EXCL</span>
                                <span style="color: #F92672;">if</span> (n-&gt;nlmsg_flags&amp;NLM_F_EXCL)
                                        <span style="color: #F92672;">return</span> -EEXIST;
                                <span style="color: #75715E;">//</span><span style="color: #75715E;">tc&#21629;&#20196;&#30340;&#31639;&#27861;&#21517;&#21644;&#25490;&#38431;&#35268;&#21017;&#30340;&#31639;&#27861;&#21517;&#19981;&#21516;</span>
                                <span style="color: #F92672;">if</span> (tca[TCA_KIND-1] &amp;&amp; rtattr_strcmp(tca[TCA_KIND-1], q-&gt;ops-&gt;id))
                                        <span style="color: #F92672;">return</span> -EINVAL;
                                <span style="color: #F92672;">if</span> (q == p ||
                                    (p &amp;&amp; check_loop(q, p, 0))) <span style="color: #75715E;">//</span><span style="color: #75715E;">&#31639;&#27861;&#20986;&#29616;&#22238;&#29615;</span>
                                        <span style="color: #F92672;">return</span> -ELOOP;
                                atomic_inc(&amp;q-&gt;refcnt); <span style="color: #75715E;">//</span><span style="color: #75715E;">&#36882;&#22686;&#24341;&#29992;&#35745;&#25968;</span>
                                <span style="color: #F92672;">goto</span> <span style="color: #AE81FF;">graft</span>;
                        } <span style="color: #F92672;">else</span> {
                                <span style="color: #F92672;">if</span> (q == <span style="color: #AE81FF;">NULL</span>) <span style="color: #75715E;">//</span><span style="color: #75715E;">&#26410;&#25351;&#23450;&#25490;&#38431;&#35268;&#21017;&#65292;&#21017;&#21019;&#24314;</span>
                                        <span style="color: #F92672;">goto</span> <span style="color: #AE81FF;">create_n_graft</span>;

                                <span style="color: #F92672;">if</span> ((n-&gt;nlmsg_flags&amp;NLM_F_CREATE) &amp;&amp;
                                    (n-&gt;nlmsg_flags&amp;NLM_F_REPLACE) &amp;&amp;
                                    ((n-&gt;nlmsg_flags&amp;NLM_F_EXCL) ||
                                     (tca[TCA_KIND-1] &amp;&amp;
                                      rtattr_strcmp(tca[TCA_KIND-1], q-&gt;ops-&gt;id))))
                                        <span style="color: #F92672;">goto</span> <span style="color: #AE81FF;">create_n_graft</span>;
                        }
                }
        } <span style="color: #F92672;">else</span> {
                <span style="color: #F92672;">if</span> (<span style="color: #E6DB74; font-weight: bold;">!</span>tcm-&gt;tcm_handle) <span style="color: #75715E;">//</span><span style="color: #75715E;">&#26410;&#25351;&#23450;&#29238;&#32467;&#28857;&#21477;&#26564;</span>
                        <span style="color: #F92672;">return</span> -EINVAL;
                q = qdisc_lookup(dev, tcm-&gt;tcm_handle); <span style="color: #75715E;">//</span><span style="color: #75715E;">&#26681;&#25454;&#21477;&#26564;&#33719;&#21462;&#25490;&#38431;&#35268;&#21017;</span>
        }

        <span style="color: #75715E;">/* </span><span style="color: #75715E;">Change qdisc parameters</span><span style="color: #75715E;"> */</span>
        <span style="color: #F92672;">if</span> (q == <span style="color: #AE81FF;">NULL</span>) <span style="color: #75715E;">//</span><span style="color: #75715E;">&#27809;&#26377;&#33719;&#21462;&#21040;&#25490;&#38431;&#35268;&#21017;</span>
                <span style="color: #F92672;">return</span> -ENOENT;
        <span style="color: #F92672;">if</span> (n-&gt;nlmsg_flags&amp;NLM_F_EXCL) <span style="color: #75715E;">//</span><span style="color: #75715E;">&#33719;&#21462;&#21040;&#20102;&#24453;&#20462;&#25913;&#30340;&#25490;&#38431;&#35268;&#21017;&#65292;&#20294;&#26159;&#21442;&#25968;&#35774;&#32622;&#20102;NLM_F_EXCL</span>
                <span style="color: #F92672;">return</span> -EEXIST;
        <span style="color: #F92672;">if</span> (tca[TCA_KIND-1] &amp;&amp; rtattr_strcmp(tca[TCA_KIND-1], q-&gt;ops-&gt;id)) <span style="color: #75715E;">//</span><span style="color: #75715E;">&#23384;&#22312;&#31639;&#27861;&#21517;&#65292;&#20294;&#26159;&#21644;&#25490;&#38431;&#35268;&#21017;&#30340;&#31639;&#27861;&#21517;&#19981;&#21516;</span>
                <span style="color: #F92672;">return</span> -EINVAL;
        err = qdisc_change(q, tca); <span style="color: #75715E;">//</span><span style="color: #75715E;">&#20462;&#25913;&#25490;&#38431;&#35268;&#21017;&#21442;&#25968;</span>
        <span style="color: #F92672;">if</span> (err == 0)
                qdisc_notify(skb, n, clid, <span style="color: #AE81FF;">NULL</span>, q); <span style="color: #75715E;">//</span><span style="color: #75715E;">&#21457;&#36865;&#30830;&#35748;&#28040;&#24687;&#32473;&#20462;&#25913;&#37197;&#32622;&#30340;&#36827;&#31243;</span>
        <span style="color: #F92672;">return</span> err;

<span style="color: #AE81FF;">create_n_graft</span>: <span style="color: #75715E;">//</span><span style="color: #75715E;">&#21019;&#24314;&#25490;&#38431;&#35268;&#21017;</span>
        <span style="color: #F92672;">if</span> (<span style="color: #E6DB74; font-weight: bold;">!</span>(n-&gt;nlmsg_flags&amp;NLM_F_CREATE))
                <span style="color: #F92672;">return</span> -ENOENT;
        <span style="color: #F92672;">if</span> (clid == TC_H_INGRESS)
                q = qdisc_create(dev, tcm-&gt;tcm_parent, tca, &amp;err);
        <span style="color: #F92672;">else</span>
                q = qdisc_create(dev, tcm-&gt;tcm_handle, tca, &amp;err);
        <span style="color: #F92672;">if</span> (q == <span style="color: #AE81FF;">NULL</span>) {
                <span style="color: #F92672;">if</span> (err == -EAGAIN)
                        <span style="color: #F92672;">goto</span> <span style="color: #AE81FF;">replay</span>;
                <span style="color: #F92672;">return</span> err;
        }

<span style="color: #AE81FF;">graft</span>: <span style="color: #75715E;">//</span><span style="color: #75715E;">&#25490;&#38431;&#35268;&#21017;&#21019;&#24314;&#25110;&#32773;&#20462;&#25913;&#25104;&#21151;&#65292;&#38656;&#35201;&#37325;&#26032;&#32465;&#23450;&#31867;&#12290;</span>
        <span style="color: #F92672;">if</span> (1) {
                <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *<span style="color: #FD971F;">old_q</span> = <span style="color: #AE81FF;">NULL</span>;
                err = qdisc_graft(dev, p, clid, q, &amp;old_q); <span style="color: #75715E;">//</span><span style="color: #75715E;">&#37325;&#26032;&#32465;&#23450;&#31867;</span>
                <span style="color: #F92672;">if</span> (err) {<span style="color: #75715E;">//</span><span style="color: #75715E;">&#22833;&#36133;&#21017;&#37322;&#25918;&#25490;&#38431;&#35268;&#21017;</span>
                        <span style="color: #F92672;">if</span> (q) {
                                spin_lock_bh(&amp;dev-&gt;queue_lock);
                                qdisc_destroy(q);
                                spin_unlock_bh(&amp;dev-&gt;queue_lock);
                        }
                        <span style="color: #F92672;">return</span> err;
                }
                qdisc_notify(skb, n, clid, old_q, q);<span style="color: #75715E;">//</span><span style="color: #75715E;">&#36890;&#30693;&#36827;&#31243;</span>
                <span style="color: #F92672;">if</span> (old_q) {<span style="color: #75715E;">//</span><span style="color: #75715E;">&#37322;&#25918;&#21407;&#20808;&#30340;&#25490;&#38431;&#35268;&#21017;</span>
                        spin_lock_bh(&amp;dev-&gt;queue_lock);
                        qdisc_destroy(old_q);
                        spin_unlock_bh(&amp;dev-&gt;queue_lock);
                }
        }
        <span style="color: #F92672;">return</span> 0;
}
</pre>
</div>
</div>

<div id="outline-container-org0a61b43" class="outline-3">
<h3 id="org0a61b43"><span class="section-number-3">5.1.</span> 类的创建接口</h3>
<div class="outline-text-3" id="text-5-1">
<p>
使用tc工具配置排队规则的类时，最终通过tc_ctl_tclass()处理。
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #F92672;">static</span> <span style="color: #66D9EF;">int</span> <span style="color: #A6E22E;">tc_ctl_tclass</span>(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">sk_buff</span> *<span style="color: #FD971F;">skb</span>, <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">nlmsghdr</span> *<span style="color: #FD971F;">n</span>, <span style="color: #66D9EF;">void</span> *<span style="color: #FD971F;">arg</span>)
{
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">tcmsg</span> *<span style="color: #FD971F;">tcm</span> = NLMSG_DATA(n);
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">rtattr</span> **<span style="color: #FD971F;">tca</span> = arg;
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">net_device</span> *<span style="color: #FD971F;">dev</span>;
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span> *<span style="color: #FD971F;">q</span> = <span style="color: #AE81FF;">NULL</span>;
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc_class_ops</span> *<span style="color: #FD971F;">cops</span>;
        <span style="color: #66D9EF;">unsigned</span> <span style="color: #66D9EF;">long</span> <span style="color: #FD971F;">cl</span> = 0;
        <span style="color: #66D9EF;">unsigned</span> <span style="color: #66D9EF;">long</span> <span style="color: #FD971F;">new_cl</span>;
        <span style="color: #66D9EF;">u32</span> <span style="color: #FD971F;">pid</span> = tcm-&gt;tcm_parent;
        <span style="color: #66D9EF;">u32</span> <span style="color: #FD971F;">clid</span> = tcm-&gt;tcm_handle;
        <span style="color: #66D9EF;">u32</span> <span style="color: #FD971F;">qid</span> = TC_H_MAJ(clid);
        <span style="color: #66D9EF;">int</span> <span style="color: #FD971F;">err</span>;
        <span style="color: #F92672;">if</span> ((dev = __dev_get_by_index(tcm-&gt;tcm_ifindex)) == <span style="color: #AE81FF;">NULL</span>)
                <span style="color: #F92672;">return</span> -ENODEV;

        <span style="color: #75715E;">/* </span><span style="color: #75715E;">&#39318;&#20808;&#30830;&#23450;&#35201;&#32465;&#23450;&#30340;&#25490;&#38431;&#35268;&#21017;&#65292;&#21450;&#20854;&#29238;&#25490;&#38431;&#35268;&#21017;&#30340;&#21477;&#26564;&#65292;&#30830;&#23450;&#35268;&#21017;&#35265;&#19979;&#34920;</span><span style="color: #75715E;"> */</span>
        <span style="color: #F92672;">if</span> (pid != TC_H_ROOT) { <span style="color: #75715E;">//</span><span style="color: #75715E;">&#29238;&#25490;&#38431;&#35268;&#21017;&#19981;&#26159;&#26681;&#25490;&#38431;&#35268;&#21017;</span>
                <span style="color: #66D9EF;">u32</span> <span style="color: #FD971F;">qid1</span> = TC_H_MAJ(pid);
                <span style="color: #F92672;">if</span> (qid &amp;&amp; qid1) {<span style="color: #75715E;">//</span>
                        <span style="color: #75715E;">/* </span><span style="color: #75715E;">&#25351;&#23450;&#30340;&#25490;&#38431;&#35268;&#21017;&#21644;&#29238;&#25490;&#38431;&#35268;&#21017;&#30340;&#39640;16&#20301;&#20027;&#32534;&#21495;&#24517;&#39035;&#30456;&#21516;</span><span style="color: #75715E;"> */</span>
                        <span style="color: #F92672;">if</span> (qid != qid1)
                                <span style="color: #F92672;">return</span> -EINVAL;
                } <span style="color: #F92672;">else</span> <span style="color: #F92672;">if</span> (qid1) {<span style="color: #75715E;">//</span><span style="color: #75715E;">&#26410;&#25351;&#23450;&#25490;&#38431;&#35268;&#21017;&#20027;&#32534;&#21495;&#65292;&#20174;&#29238;&#25490;&#38431;&#35268;&#21017;&#33719;&#21462;</span>
                        qid = qid1;
                } <span style="color: #F92672;">else</span> <span style="color: #F92672;">if</span> (qid == 0)<span style="color: #75715E;">//</span><span style="color: #75715E;">&#37117;&#27809;&#26377;&#25351;&#23450;&#65292;&#21017;&#20174;&#32593;&#32476;&#35774;&#22791;&#30340;qdisc_sleeping&#20013;&#33719;&#21462;</span>
                        qid = dev-&gt;qdisc_sleeping-&gt;handle;
                <span style="color: #75715E;">//</span><span style="color: #75715E;">&#30830;&#23450;&#20102;&#29238;&#25490;&#38431;&#35268;&#21017;&#20027;&#32534;&#21495;</span>
                <span style="color: #F92672;">if</span> (pid)
                        pid = TC_H_MAKE(qid, pid); <span style="color: #75715E;">//</span><span style="color: #75715E;">&#37325;&#26032;&#35745;&#31639;&#29238;&#25490;&#38431;&#35268;&#21017;&#21477;&#26564;</span>
        } <span style="color: #F92672;">else</span> {<span style="color: #75715E;">//</span><span style="color: #75715E;">&#29238;&#25490;&#38431;&#35268;&#21017;&#26159;&#26681;&#25490;&#38431;&#35268;&#21017;</span>
                <span style="color: #F92672;">if</span> (qid == 0) <span style="color: #75715E;">//</span><span style="color: #75715E;">&#20026;&#25351;&#23450;&#25490;&#38431;&#35268;&#21017;&#20027;&#32534;&#21495;&#65292;&#21017;&#20174;&#32593;&#32476;&#35774;&#22791;&#33719;&#21462;</span>
                        qid = dev-&gt;qdisc_sleeping-&gt;handle;
        }

        <span style="color: #75715E;">/* </span><span style="color: #75715E;">&#26597;&#25214;&#25110;&#32773;&#21019;&#24314;&#25490;&#38431;&#35268;&#21017;</span><span style="color: #75715E;"> */</span>
        <span style="color: #F92672;">if</span> ((q = qdisc_lookup(dev, qid)) == <span style="color: #AE81FF;">NULL</span>)
                <span style="color: #F92672;">return</span> -ENOENT;

        <span style="color: #75715E;">/* </span><span style="color: #75715E;">&#33719;&#21462;&#25490;&#38431;&#35268;&#21017;&#30340;&#31867;&#25805;&#20316;&#25509;&#21475;</span><span style="color: #75715E;"> */</span>
        cops = q-&gt;ops-&gt;cl_ops;
        <span style="color: #F92672;">if</span> (cops == <span style="color: #AE81FF;">NULL</span>)
                <span style="color: #F92672;">return</span> -EINVAL;

        <span style="color: #75715E;">/* </span><span style="color: #75715E;">&#23581;&#35797;&#33719;&#21462;&#25490;&#38431;&#35268;&#21017;&#30340;&#31867;</span><span style="color: #75715E;">*/</span>
        <span style="color: #F92672;">if</span> (clid == 0) {
                <span style="color: #F92672;">if</span> (pid == TC_H_ROOT)
                        clid = qid;
        } <span style="color: #F92672;">else</span>
                clid = TC_H_MAKE(qid, clid);
        <span style="color: #F92672;">if</span> (clid)
                cl = cops-&gt;get(q, clid);

        <span style="color: #F92672;">if</span> (cl == 0) { <span style="color: #75715E;">// </span><span style="color: #75715E;">&#27809;&#26377;&#25214;&#21040;&#31867;</span>
                err = -ENOENT;
                <span style="color: #F92672;">if</span> (n-&gt;nlmsg_type != RTM_NEWTCLASS || <span style="color: #E6DB74; font-weight: bold;">!</span>(n-&gt;nlmsg_flags&amp;NLM_F_CREATE)) <span style="color: #75715E;">//</span><span style="color: #75715E;">&#26159;&#21542;&#25351;&#23450;&#21019;&#24314;&#21629;&#20196;</span>
                        <span style="color: #F92672;">goto</span> <span style="color: #AE81FF;">out</span>;
        } <span style="color: #F92672;">else</span> {<span style="color: #75715E;">//</span><span style="color: #75715E;">&#25214;&#21040;&#31867;&#65292; &#26681;&#25454;&#25805;&#20316;&#31867;&#22411;&#22788;&#29702;</span>
                <span style="color: #F92672;">switch</span> (n-&gt;nlmsg_type) {
                <span style="color: #F92672;">case</span> RTM_NEWTCLASS: <span style="color: #75715E;">//</span><span style="color: #75715E;">&#21019;&#24314;</span>
                        err = -EEXIST;
                        <span style="color: #F92672;">if</span> (n-&gt;nlmsg_flags&amp;NLM_F_EXCL)
                                <span style="color: #F92672;">goto</span> <span style="color: #AE81FF;">out</span>;
                        <span style="color: #F92672;">break</span>;
                <span style="color: #F92672;">case</span> RTM_DELTCLASS: <span style="color: #75715E;">//</span><span style="color: #75715E;">&#21024;&#38500;</span>
                        err = cops-&gt;delete(q, cl);
                        <span style="color: #F92672;">if</span> (err == 0)
                                tclass_notify(skb, n, q, cl, RTM_DELTCLASS);
                        <span style="color: #F92672;">goto</span> <span style="color: #AE81FF;">out</span>;
                <span style="color: #F92672;">case</span> RTM_GETTCLASS: <span style="color: #75715E;">//</span><span style="color: #75715E;">&#33719;&#21462;</span>
                        err = tclass_notify(skb, n, q, cl, RTM_NEWTCLASS);
                        <span style="color: #F92672;">goto</span> <span style="color: #AE81FF;">out</span>;
                <span style="color: #F92672;">default</span>: <span style="color: #75715E;">//</span><span style="color: #75715E;">&#26080;&#25928;&#25805;&#20316;</span>
                        err = -EINVAL;
                        <span style="color: #F92672;">goto</span> <span style="color: #AE81FF;">out</span>;
                }
        }
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#26032;&#24314;&#25110;&#32773;&#20462;&#25913;&#31867;&#30340;&#25805;&#20316;&#65292;&#37117;&#36890;&#36807;change&#25509;&#21475;&#22788;&#29702;&#12290;</span>
        new_cl = cl;
        err = cops-&gt;change(q, clid, pid, tca, &amp;new_cl);
        <span style="color: #F92672;">if</span> (err == 0)<span style="color: #75715E;">//</span><span style="color: #75715E;">&#25104;&#21151;&#21518;&#36890;&#30693;&#24212;&#29992;&#31243;&#24207;</span>
                tclass_notify(skb, n, q, new_cl, RTM_NEWTCLASS);
<span style="color: #AE81FF;">out</span>:
        <span style="color: #F92672;">if</span> (cl)
                cops-&gt;put(q, cl);
        <span style="color: #F92672;">return</span> err;
}
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 2:</span> 确定父排队规则句柄的规则</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Parent Handle</th>
<th scope="col" class="org-left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">TC_H_UNSPEC</td>
<td class="org-left">无效的父排队规则句柄</td>
</tr>

<tr>
<td class="org-left">TC_H_ROOT</td>
<td class="org-left">表示为根排队规则的类，没有父排队规则</td>
</tr>

<tr>
<td class="org-left">X:0</td>
<td class="org-left">父排队规则是根排队规则</td>
</tr>

<tr>
<td class="org-left">X:Y</td>
<td class="org-left">父排队规则是一个普通结点</td>
</tr>

<tr>
<td class="org-left">0:Y</td>
<td class="org-left">如果父排队规则为X:Y，则排队规则为X:0</td>
</tr>
</tbody>
</table>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 3:</span> 确定排队规则句柄的规则</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">handle</th>
<th scope="col" class="org-left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">0:0</td>
<td class="org-left">系统自动分配</td>
</tr>

<tr>
<td class="org-left">0:Y</td>
<td class="org-left">类的句柄为X:Y，则与之绑定的排队规则句柄为 X:0</td>
</tr>

<tr>
<td class="org-left">X:Y</td>
<td class="org-left">明确指定与之绑定的排队规则为X:0</td>
</tr>

<tr>
<td class="org-left">X:0</td>
<td class="org-left">根类</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgfa83de9" class="outline-3">
<h3 id="orgfa83de9"><span class="section-number-3">5.2.</span> 过滤器的创建接口</h3>
<div class="outline-text-3" id="text-5-2">
<p>
使用tc工具配置类的过滤器时，最终通过 tc_ctl_tfilter() 处理。
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #F92672;">static</span> <span style="color: #66D9EF;">int</span> <span style="color: #A6E22E;">tc_ctl_tfilter</span>(<span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">sk_buff</span> *<span style="color: #FD971F;">skb</span>, <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">nlmsghdr</span> *<span style="color: #FD971F;">n</span>, <span style="color: #66D9EF;">void</span> *<span style="color: #FD971F;">arg</span>)
{
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">rtattr</span> **<span style="color: #FD971F;">tca</span>;
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">tcmsg</span> *<span style="color: #FD971F;">t</span>;
        <span style="color: #66D9EF;">u32</span> <span style="color: #FD971F;">protocol</span>;
        <span style="color: #66D9EF;">u32</span> <span style="color: #FD971F;">prio</span>;
        <span style="color: #66D9EF;">u32</span> <span style="color: #FD971F;">nprio</span>;
        <span style="color: #66D9EF;">u32</span> <span style="color: #FD971F;">parent</span>;
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">net_device</span> *<span style="color: #FD971F;">dev</span>;
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc</span>  *<span style="color: #FD971F;">q</span>;
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">tcf_proto</span> **<span style="color: #FD971F;">back</span>, **<span style="color: #FD971F;">chain</span>;
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">tcf_proto</span> *<span style="color: #FD971F;">tp</span>;
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">tcf_proto_ops</span> *<span style="color: #FD971F;">tp_ops</span>;
        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">Qdisc_class_ops</span> *<span style="color: #FD971F;">cops</span>;
        <span style="color: #66D9EF;">unsigned</span> <span style="color: #66D9EF;">long</span> <span style="color: #FD971F;">cl</span>;
        <span style="color: #66D9EF;">unsigned</span> <span style="color: #66D9EF;">long</span> <span style="color: #FD971F;">fh</span>;
        <span style="color: #66D9EF;">int</span> <span style="color: #FD971F;">err</span>;

<span style="color: #AE81FF;">replay</span>:
        tca = arg;
        t = NLMSG_DATA(n);
        protocol = TC_H_MIN(t-&gt;tcm_info); <span style="color: #75715E;">//</span><span style="color: #75715E;">&#32593;&#32476;&#21327;&#35758;&#21495;</span>
        prio = TC_H_MAJ(t-&gt;tcm_info); <span style="color: #75715E;">//</span><span style="color: #75715E;">&#20248;&#20808;&#32423;</span>
        nprio = prio;
        parent = t-&gt;tcm_parent; <span style="color: #75715E;">//</span><span style="color: #75715E;">&#29238;&#25490;&#38431;&#35268;&#21017;</span>
        cl = 0;

        <span style="color: #F92672;">if</span> (prio == 0) { <span style="color: #75715E;">//</span><span style="color: #75715E;">&#26410;&#25351;&#23450;&#20248;&#20808;&#32423;&#65292;&#21017;&#21028;&#26029;&#26159;&#21542;&#36827;&#34892;&#33258;&#21160;&#20998;&#37197;</span>
                <span style="color: #75715E;">/* </span><span style="color: #75715E;">If no priority is given, user wants we allocated it.</span><span style="color: #75715E;"> */</span>
                <span style="color: #F92672;">if</span> (n-&gt;nlmsg_type != RTM_NEWTFILTER || <span style="color: #E6DB74; font-weight: bold;">!</span>(n-&gt;nlmsg_flags&amp;NLM_F_CREATE))
                        <span style="color: #F92672;">return</span> -ENOENT;
                prio = TC_H_MAKE(0x80000000U,0U);
        }
        <span style="color: #75715E;">/* </span><span style="color: #75715E;">Find head of filter chain.</span><span style="color: #75715E;"> */</span>
        <span style="color: #F92672;">if</span> ((dev = __dev_get_by_index(t-&gt;tcm_ifindex)) == <span style="color: #AE81FF;">NULL</span>)
                <span style="color: #F92672;">return</span> -ENODEV;
        <span style="color: #75715E;">/* </span><span style="color: #75715E;">Find qdisc</span><span style="color: #75715E;"> */</span>
        <span style="color: #F92672;">if</span> (<span style="color: #E6DB74; font-weight: bold;">!</span>parent) { <span style="color: #75715E;">//</span><span style="color: #75715E;">&#20026;&#25351;&#23450;&#29238;&#25490;&#38431;&#35268;&#21017;&#21477;&#26564;&#65292;&#20351;&#29992;&#32593;&#32476;&#35774;&#22791;&#30340;&#37197;&#32622;</span>
                q = dev-&gt;qdisc_sleeping;
                parent = q-&gt;handle;
        } <span style="color: #F92672;">else</span> <span style="color: #F92672;">if</span> ((q = qdisc_lookup(dev, TC_H_MAJ(t-&gt;tcm_parent))) == <span style="color: #AE81FF;">NULL</span>)<span style="color: #75715E;">//</span><span style="color: #75715E;">&#26597;&#25214;&#29238;&#25490;&#38431;&#35268;&#21017;</span>
                <span style="color: #F92672;">return</span> -EINVAL;

        <span style="color: #75715E;">/* </span><span style="color: #75715E;">&#21019;&#24314;&#36807;&#28388;&#22120;&#65292;&#24517;&#39035;&#25903;&#25345;&#31867;&#25805;&#20316;&#25509;&#21475;</span><span style="color: #75715E;"> */</span>
        <span style="color: #F92672;">if</span> ((cops = q-&gt;ops-&gt;cl_ops) == <span style="color: #AE81FF;">NULL</span>)
                <span style="color: #F92672;">return</span> -EINVAL;
        <span style="color: #75715E;">/* </span><span style="color: #75715E;">Do we search for filter, attached to class?</span><span style="color: #75715E;"> */</span>
        <span style="color: #F92672;">if</span> (TC_H_MIN(parent)) {
                cl = cops-&gt;get(q, parent); <span style="color: #75715E;">//</span><span style="color: #75715E;">&#33719;&#21462;&#29238;&#25490;&#38431;&#35268;&#21017;&#30340;&#31867;</span>
                <span style="color: #F92672;">if</span> (cl == 0)
                        <span style="color: #F92672;">return</span> -ENOENT;
        }

        <span style="color: #75715E;">/* </span><span style="color: #75715E;">&#33719;&#21462;&#31867;&#30340;&#36807;&#28388;&#22120;&#38142;&#34920;</span><span style="color: #75715E;"> */</span>
        chain = cops-&gt;tcf_chain(q, cl);
        err = -EINVAL;
        <span style="color: #F92672;">if</span> (chain == <span style="color: #AE81FF;">NULL</span>)
                <span style="color: #F92672;">goto</span> <span style="color: #AE81FF;">errout</span>;

        <span style="color: #75715E;">/* </span><span style="color: #75715E;">&#36941;&#21382;&#38142;&#34920;&#26597;&#35810;&#23545;&#24212;&#21327;&#35758;&#21495;&#21644;&#20248;&#20808;&#32423;&#30340;&#36807;&#28388;&#22120;</span><span style="color: #75715E;"> */</span>
        <span style="color: #F92672;">for</span> (back = chain; (tp=*back) != <span style="color: #AE81FF;">NULL</span>; back = &amp;tp-&gt;next) {
                <span style="color: #F92672;">if</span> (tp-&gt;prio &gt;= prio) {
                        <span style="color: #F92672;">if</span> (tp-&gt;prio == prio) {
                                <span style="color: #F92672;">if</span> (<span style="color: #E6DB74; font-weight: bold;">!</span>nprio || (tp-&gt;protocol != protocol &amp;&amp; protocol))
                                        <span style="color: #F92672;">goto</span> <span style="color: #AE81FF;">errout</span>;
                        } <span style="color: #F92672;">else</span>
                                tp = <span style="color: #AE81FF;">NULL</span>;
                        <span style="color: #F92672;">break</span>;
                }
        }

        <span style="color: #F92672;">if</span> (tp == <span style="color: #AE81FF;">NULL</span>) { <span style="color: #75715E;">//</span><span style="color: #75715E;">&#27809;&#26377;&#25214;&#21040;&#36807;&#28388;&#22120;&#65292;&#25191;&#34892;&#21019;&#24314;</span>
                <span style="color: #F92672;">if</span> (tca[TCA_KIND-1] == <span style="color: #AE81FF;">NULL</span> || <span style="color: #E6DB74; font-weight: bold;">!</span>protocol)
                        <span style="color: #F92672;">goto</span> <span style="color: #AE81FF;">errout</span>;
                err = -ENOENT;
                <span style="color: #F92672;">if</span> (n-&gt;nlmsg_type != RTM_NEWTFILTER || <span style="color: #E6DB74; font-weight: bold;">!</span>(n-&gt;nlmsg_flags&amp;NLM_F_CREATE)) <span style="color: #75715E;">//</span><span style="color: #75715E;">&#24517;&#39035;&#20026;&#26032;&#24314;&#21629;&#20196;</span>
                        <span style="color: #F92672;">goto</span> <span style="color: #AE81FF;">errout</span>;
                err = -ENOBUFS;
                <span style="color: #F92672;">if</span> ((tp = kzalloc(<span style="color: #F92672;">sizeof</span>(*tp), GFP_KERNEL)) == <span style="color: #AE81FF;">NULL</span>)
                        <span style="color: #F92672;">goto</span> <span style="color: #AE81FF;">errout</span>;
                err = -EINVAL;
                tp_ops = tcf_proto_lookup_ops(tca[TCA_KIND-1]); <span style="color: #75715E;">//</span><span style="color: #75715E;">&#26597;&#25214;&#36807;&#28388;&#22120;&#25805;&#20316;&#32467;&#26500;</span>
                <span style="color: #F92672;">if</span> (tp_ops == <span style="color: #AE81FF;">NULL</span>) { <span style="color: #75715E;">//</span><span style="color: #75715E;">&#20026;&#25214;&#21040;&#65292;&#23581;&#35797;&#21152;&#36733;&#27169;&#22359;</span>
<span style="color: #F92672;">#ifdef</span> CONFIG_KMOD
                        <span style="color: #F92672;">struct</span> <span style="color: #66D9EF;">rtattr</span> *<span style="color: #FD971F;">kind</span> = tca[TCA_KIND-1];
                        <span style="color: #66D9EF;">char</span> <span style="color: #FD971F;">name</span>[IFNAMSIZ];

                        <span style="color: #F92672;">if</span> (kind != <span style="color: #AE81FF;">NULL</span> &amp;&amp;
                            rtattr_strlcpy(name, kind, IFNAMSIZ) &lt; IFNAMSIZ) {
                                rtnl_unlock();
                                request_module(<span style="color: #E6DB74;">"cls_%s"</span>, name);
                                rtnl_lock();
                                tp_ops = tcf_proto_lookup_ops(kind);
                                <span style="color: #75715E;">/* </span><span style="color: #75715E;">We dropped the RTNL semaphore in order to</span>
<span style="color: #75715E;">                                 * perform the module load.  So, even if we</span>
<span style="color: #75715E;">                                 * succeeded in loading the module we have to</span>
<span style="color: #75715E;">                                 * replay the request.  We indicate this using</span>
<span style="color: #75715E;">                                 * -EAGAIN.</span>
<span style="color: #75715E;">                                 */</span>
                                <span style="color: #F92672;">if</span> (tp_ops != <span style="color: #AE81FF;">NULL</span>) {
                                        module_put(tp_ops-&gt;owner);
                                        err = -EAGAIN;
                                }
                        }
<span style="color: #F92672;">#endif</span>
                        kfree(tp);
                        <span style="color: #F92672;">goto</span> <span style="color: #AE81FF;">errout</span>;
                }
                <span style="color: #75715E;">//</span><span style="color: #75715E;">&#21021;&#22987;&#21270;&#26032;&#21019;&#24314;&#30340;&#36807;&#28388;&#22120;</span>
                tp-&gt;ops = tp_ops;
                tp-&gt;protocol = protocol;
                tp-&gt;prio = nprio ? : tcf_auto_prio(*back);
                tp-&gt;q = q;
                tp-&gt;classify = tp_ops-&gt;classify;
                tp-&gt;classid = parent;
                <span style="color: #F92672;">if</span> ((err = tp_ops-&gt;init(tp)) != 0) {
                        module_put(tp_ops-&gt;owner);
                        kfree(tp);
                        <span style="color: #F92672;">goto</span> <span style="color: #AE81FF;">errout</span>;
                }
                <span style="color: #75715E;">//</span><span style="color: #75715E;">&#21152;&#20837;&#36807;&#28388;&#22120;&#38142;&#34920;</span>
                qdisc_lock_tree(dev);
                tp-&gt;next = *back;
                *back = tp;
                qdisc_unlock_tree(dev);

        } <span style="color: #F92672;">else</span> <span style="color: #F92672;">if</span> (tca[TCA_KIND-1] &amp;&amp; rtattr_strcmp(tca[TCA_KIND-1], tp-&gt;ops-&gt;kind)) <span style="color: #75715E;">//</span><span style="color: #75715E;">&#25214;&#21040;&#36807;&#28388;&#22120;&#65292;&#26657;&#39564;&#21517;&#31216;</span>
                <span style="color: #F92672;">goto</span> <span style="color: #AE81FF;">errout</span>;
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#23558;&#36807;&#28388;&#22120;&#21477;&#26564;&#26144;&#23556;&#20026;&#20869;&#37096;&#36807;&#28388;&#22120;&#26631;&#35782;&#31526;</span>
        fh = tp-&gt;ops-&gt;get(tp, t-&gt;tcm_handle);
        <span style="color: #F92672;">if</span> (fh == 0) { <span style="color: #75715E;">//</span><span style="color: #75715E;">&#27809;&#26377;&#25214;&#21040;&#20869;&#37096;&#36807;&#28388;&#22120;&#26631;&#35782;&#31526;</span>
                <span style="color: #F92672;">if</span> (n-&gt;nlmsg_type == RTM_DELTFILTER &amp;&amp; t-&gt;tcm_handle == 0) { <span style="color: #75715E;">//</span><span style="color: #75715E;">&#21024;&#38500;&#25805;&#20316;&#65292;&#19988;&#26410;&#25351;&#23450;&#24453;&#21024;&#38500;&#36807;&#28388;&#22120;&#21477;&#26564;</span>
                        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#25191;&#34892;&#21024;&#38500;&#25805;&#20316;</span>
                        qdisc_lock_tree(dev);
                        *back = tp-&gt;next;
                        qdisc_unlock_tree(dev);

                        tfilter_notify(skb, n, tp, fh, RTM_DELTFILTER);
                        tcf_destroy(tp);
                        err = 0;
                        <span style="color: #F92672;">goto</span> <span style="color: #AE81FF;">errout</span>;
                }

                err = -ENOENT;
                <span style="color: #F92672;">if</span> (n-&gt;nlmsg_type != RTM_NEWTFILTER || <span style="color: #E6DB74; font-weight: bold;">!</span>(n-&gt;nlmsg_flags&amp;NLM_F_CREATE))<span style="color: #75715E;">//</span><span style="color: #75715E;">&#19981;&#26159;&#21019;&#24314;&#25805;&#20316;</span>
                        <span style="color: #F92672;">goto</span> <span style="color: #AE81FF;">errout</span>;
        } <span style="color: #F92672;">else</span> { <span style="color: #75715E;">//</span><span style="color: #75715E;">&#33719;&#21462;&#21040;&#20869;&#37096;&#36807;&#28388;&#22120;&#26631;&#35782;&#31526;</span>
                <span style="color: #F92672;">switch</span> (n-&gt;nlmsg_type) {
                <span style="color: #F92672;">case</span> RTM_NEWTFILTER:
                        err = -EEXIST;
                        <span style="color: #F92672;">if</span> (n-&gt;nlmsg_flags&amp;NLM_F_EXCL)
                                <span style="color: #F92672;">goto</span> <span style="color: #AE81FF;">errout</span>;
                        <span style="color: #F92672;">break</span>;
                <span style="color: #F92672;">case</span> RTM_DELTFILTER:
                        err = tp-&gt;ops-&gt;delete(tp, fh);
                        <span style="color: #F92672;">if</span> (err == 0)
                                tfilter_notify(skb, n, tp, fh, RTM_DELTFILTER);
                        <span style="color: #F92672;">goto</span> <span style="color: #AE81FF;">errout</span>;
                <span style="color: #F92672;">case</span> RTM_GETTFILTER:
                        err = tfilter_notify(skb, n, tp, fh, RTM_NEWTFILTER);
                        <span style="color: #F92672;">goto</span> <span style="color: #AE81FF;">errout</span>;
                <span style="color: #F92672;">default</span>:
                        err = -EINVAL;
                        <span style="color: #F92672;">goto</span> <span style="color: #AE81FF;">errout</span>;
                }
        }
        <span style="color: #75715E;">//</span><span style="color: #75715E;">&#36807;&#28388;&#22120;&#30340;&#21019;&#24314;&#21644;&#20462;&#25913;&#25805;&#20316;&#37117;&#36890;&#36807;change&#25509;&#21475;&#36827;&#34892;</span>
        err = tp-&gt;ops-&gt;change(tp, cl, t-&gt;tcm_handle, tca, &amp;fh);
        <span style="color: #F92672;">if</span> (err == 0)
                tfilter_notify(skb, n, tp, fh, RTM_NEWTFILTER);
<span style="color: #AE81FF;">errout</span>:
        <span style="color: #F92672;">if</span> (cl)
                cops-&gt;put(q, cl);
        <span style="color: #F92672;">if</span> (err == -EAGAIN)
                <span style="color: #75715E;">/* </span><span style="color: #75715E;">Replay the request.</span><span style="color: #75715E;"> */</span>
                <span style="color: #F92672;">goto</span> <span style="color: #AE81FF;">replay</span>;
        <span style="color: #F92672;">return</span> err;
}
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: nandfan</p>
<p class="email">Email: <a href="mailto:nanders.fan@outlook.com">nanders.fan@outlook.com</a></p>
<p class="date">Created: 2024-06-23 Sun 15:55</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
